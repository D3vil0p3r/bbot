
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="OSINT automation for hackers" name="description"/>
<meta content="TheTechromancer" name="author"/>
<link href="https://blacklanternsecurity.github.io/bbot/Dev/dev/engine/" rel="canonical"/>
<link href="../core/" rel="prev"/>
<link href="../helpers/" rel="next"/>
<link href="../../favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.5.42" name="generator"/>
<title>Engine - BBOT Docs</title>
<link href="../../assets/stylesheets/main.0253249f.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../../assets/_mkdocstrings.css" rel="stylesheet"/>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<link href="../../assets/stylesheets/extra-style.zp8hmobp.min.css" rel="stylesheet"/></head>
<body data-md-color-accent="deep-orange" data-md-color-primary="black" data-md-color-scheme="slate" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#bbot.core.engine.EngineBase">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<div data-md-color-scheme="default" data-md-component="outdated" hidden="">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="BBOT Docs" class="md-header__button md-logo" data-md-component="logo" href="../.." title="BBOT Docs">
<img alt="logo" src="../../bbot.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            BBOT Docs
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Engine
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-hidden="true" class="md-option" data-md-color-accent="deep-orange" data-md-color-media="" data-md-color-primary="black" data-md-color-scheme="slate" id="__palette_0" name="__palette" type="radio"/>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/blacklanternsecurity/bbot" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    blacklanternsecurity/bbot
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../..">
          
  
  User Manual

        </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../">
          
  
  Developer Manual

        </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="BBOT Docs" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="BBOT Docs">
<img alt="logo" src="../../bbot.png"/>
</a>
    BBOT Docs
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/blacklanternsecurity/bbot" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    blacklanternsecurity/bbot
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
<span class="md-ellipsis">
    User Manual
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_1_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_1">
<span class="md-nav__icon md-icon"></span>
            User Manual
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_1_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_1_1" id="__nav_1_1_label" tabindex="0">
<span class="md-ellipsis">
    Basics
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_1_1_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_1_1">
<span class="md-nav__icon md-icon"></span>
            Basics
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    Getting Started
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../how_it_works/">
<span class="md-ellipsis">
    How it Works
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../comparison/">
<span class="md-ellipsis">
    Comparison to Other Tools
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_1_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_1_2" id="__nav_1_2_label" tabindex="0">
<span class="md-ellipsis">
    Scanning
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_1_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_1_2">
<span class="md-nav__icon md-icon"></span>
            Scanning
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../scanning/">
<span class="md-ellipsis">
    Scanning Overview
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_1_2_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_1_2_2" id="__nav_1_2_2_label" tabindex="0">
<span class="md-ellipsis">
    Presets
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_1_2_2_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_1_2_2">
<span class="md-nav__icon md-icon"></span>
            Presets
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../scanning/presets/">
<span class="md-ellipsis">
    Overview
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../scanning/presets_list/">
<span class="md-ellipsis">
    List of Presets
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../scanning/events/">
<span class="md-ellipsis">
    Events
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../scanning/output/">
<span class="md-ellipsis">
    Output
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../scanning/tips_and_tricks/">
<span class="md-ellipsis">
    Tips and Tricks
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../scanning/advanced/">
<span class="md-ellipsis">
    Advanced Usage
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../scanning/configuration/">
<span class="md-ellipsis">
    Configuration
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_1_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_1_3" id="__nav_1_3_label" tabindex="0">
<span class="md-ellipsis">
    Modules
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_1_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_1_3">
<span class="md-nav__icon md-icon"></span>
            Modules
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../modules/list_of_modules/">
<span class="md-ellipsis">
    List of Modules
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../modules/nuclei/">
<span class="md-ellipsis">
    Nuclei
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_1_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_1_4" id="__nav_1_4_label" tabindex="0">
<span class="md-ellipsis">
    Misc
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_1_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_1_4">
<span class="md-nav__icon md-icon"></span>
            Misc
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../contribution/">
<span class="md-ellipsis">
    Contribution
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../release_history/">
<span class="md-ellipsis">
    Release History
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../troubleshooting/">
<span class="md-ellipsis">
    Troubleshooting
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
<span class="md-ellipsis">
    Developer Manual
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Developer Manual
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../">
<span class="md-ellipsis">
    Development Overview
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../dev_environment/">
<span class="md-ellipsis">
    Setting Up a Dev Environment
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../architecture/">
<span class="md-ellipsis">
    BBOT Internal Architecture
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../module_howto/">
<span class="md-ellipsis">
    How to Write a BBOT Module
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../tests/">
<span class="md-ellipsis">
    Unit Tests
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../discord_bot/">
<span class="md-ellipsis">
    Discord Bot Example
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_2_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="">
<span class="md-ellipsis">
    Code Reference
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_2_7_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_7">
<span class="md-nav__icon md-icon"></span>
            Code Reference
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../scanner/">
<span class="md-ellipsis">
    Scanner
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../presets/">
<span class="md-ellipsis">
    Presets
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../event/">
<span class="md-ellipsis">
    Event
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../target/">
<span class="md-ellipsis">
    Target
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../basemodule/">
<span class="md-ellipsis">
    BaseModule
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../core/">
<span class="md-ellipsis">
    BBOTCore
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    Engine
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2_7_8" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_7_8" id="__nav_2_7_8_label" tabindex="0">
<span class="md-ellipsis">
    Helpers
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_7_8_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_7_8">
<span class="md-nav__icon md-icon"></span>
            Helpers
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../helpers/">
<span class="md-ellipsis">
    Overview
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../helpers/command/">
<span class="md-ellipsis">
    Command
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../helpers/dns/">
<span class="md-ellipsis">
    DNS
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../helpers/interactsh/">
<span class="md-ellipsis">
    Interactsh
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../helpers/misc/">
<span class="md-ellipsis">
    Miscellaneous
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../helpers/web/">
<span class="md-ellipsis">
    Web
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../helpers/wordcloud/">
<span class="md-ellipsis">
    Word Cloud
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<div class="doc doc-object doc-class">
<h1 class="doc doc-heading" id="bbot.core.engine.EngineBase">
<span class="doc doc-object-name doc-class-name">EngineBase</span>
</h1>
<div class="doc doc-contents first">
<p>Base Engine class for Server and Client.</p>
<p>An Engine is a simple and lightweight RPC implementation that allows offloading async tasks
to a separate process. It leverages ZeroMQ in a ROUTER-DEALER configuration.</p>
<p>BBOT makes use of this by spawning a dedicated engine for DNS and HTTP tasks.
This offloads I/O and helps free up the main event loop for other tasks.</p>
<p>To use Engine, you must subclass both EngineClient and EngineServer.</p>
<p>See the respective EngineClient and EngineServer classes for usage examples.</p>
<details class="quote">
<summary>Source code in <code>bbot/core/engine.py</code></summary>
<div class="highlight" style="background: #0d1117"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">26</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">27</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">28</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">29</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">30</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">31</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">32</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">33</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">34</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">35</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">36</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">37</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">38</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">39</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">40</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">41</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">42</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">43</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">44</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">45</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">46</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">47</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">48</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">49</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">50</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">51</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">52</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">53</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">54</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">55</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">56</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">57</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">58</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">59</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">60</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">61</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">62</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">63</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">64</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">65</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">66</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">67</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">68</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">69</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">70</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">71</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">72</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">73</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">74</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">75</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">76</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">77</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">78</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">79</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">80</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">81</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">82</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">83</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">84</span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><span style="color: #ff7b72">class</span> <span style="color: #f0883e; font-weight: bold">EngineBase</span><span style="color: #e6edf3">:</span>
<span style="color: #6e7681">    </span><span style="color: #a5d6ff">"""</span>
<span style="color: #a5d6ff">    Base Engine class for Server and Client.</span>

<span style="color: #a5d6ff">    An Engine is a simple and lightweight RPC implementation that allows offloading async tasks</span>
<span style="color: #a5d6ff">    to a separate process. It leverages ZeroMQ in a ROUTER-DEALER configuration.</span>

<span style="color: #a5d6ff">    BBOT makes use of this by spawning a dedicated engine for DNS and HTTP tasks.</span>
<span style="color: #a5d6ff">    This offloads I/O and helps free up the main event loop for other tasks.</span>

<span style="color: #a5d6ff">    To use Engine, you must subclass both EngineClient and EngineServer.</span>

<span style="color: #a5d6ff">    See the respective EngineClient and EngineServer classes for usage examples.</span>
<span style="color: #a5d6ff">    """</span>

    <span style="color: #e6edf3">ERROR_CLASS</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">BBOTEngineError</span>

    <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">__init__</span><span style="color: #e6edf3">(self,</span> <span style="color: #e6edf3">debug</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #79c0ff">False</span><span style="color: #e6edf3">):</span>
        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_shutdown_status</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #79c0ff">False</span>
        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">logging</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">getLogger(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"bbot.core.{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #79c0ff">__class__</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #79c0ff">__name__</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">lower()</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_engine_debug</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">debug</span>

    <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">pickle</span><span style="color: #e6edf3">(self,</span> <span style="color: #e6edf3">obj):</span>
        <span style="color: #ff7b72">try</span><span style="color: #e6edf3">:</span>
            <span style="color: #ff7b72">return</span> <span style="color: #e6edf3">pickle</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">dumps(obj)</span>
        <span style="color: #ff7b72">except</span> <span style="color: #f0883e; font-weight: bold">Exception</span> <span style="color: #ff7b72">as</span> <span style="color: #e6edf3">e:</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">error(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"Error serializing object: {</span><span style="color: #e6edf3">obj</span><span style="color: #a5d6ff">}: {</span><span style="color: #e6edf3">e</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">trace(traceback</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">format_exc())</span>
        <span style="color: #ff7b72">return</span> <span style="color: #e6edf3">error_sentinel</span>

    <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">unpickle</span><span style="color: #e6edf3">(self,</span> <span style="color: #e6edf3">binary):</span>
        <span style="color: #ff7b72">try</span><span style="color: #e6edf3">:</span>
            <span style="color: #ff7b72">return</span> <span style="color: #e6edf3">pickle</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">loads(binary)</span>
        <span style="color: #ff7b72">except</span> <span style="color: #f0883e; font-weight: bold">Exception</span> <span style="color: #ff7b72">as</span> <span style="color: #e6edf3">e:</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">error(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"Error deserializing binary: {</span><span style="color: #e6edf3">e</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">trace(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"Offending binary: {</span><span style="color: #e6edf3">binary</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">trace(traceback</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">format_exc())</span>
        <span style="color: #ff7b72">return</span> <span style="color: #e6edf3">error_sentinel</span>

    <span style="color: #ff7b72">async</span> <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">_infinite_retry</span><span style="color: #e6edf3">(self,</span> <span style="color: #e6edf3">callback,</span> <span style="color: #ff7b72; font-weight: bold">*</span><span style="color: #e6edf3">args,</span> <span style="color: #ff7b72; font-weight: bold">**</span><span style="color: #e6edf3">kwargs):</span>
        <span style="color: #e6edf3">interval</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">kwargs</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">pop(</span><span style="color: #a5d6ff">"_interval"</span><span style="color: #e6edf3">,</span> <span style="color: #a5d6ff">300</span><span style="color: #e6edf3">)</span>
        <span style="color: #e6edf3">context</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">kwargs</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">pop(</span><span style="color: #a5d6ff">"_context"</span><span style="color: #e6edf3">,</span> <span style="color: #a5d6ff">""</span><span style="color: #e6edf3">)</span>
        <span style="color: #8b949e; font-style: italic"># default overall timeout of 10 minutes (300 second interval * 2 iterations)</span>
        <span style="color: #e6edf3">max_retries</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">kwargs</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">pop(</span><span style="color: #a5d6ff">"_max_retries"</span><span style="color: #e6edf3">,</span> <span style="color: #a5d6ff">1</span><span style="color: #e6edf3">)</span>
        <span style="color: #ff7b72">if</span> <span style="color: #ff7b72; font-weight: bold">not</span> <span style="color: #e6edf3">context:</span>
            <span style="color: #e6edf3">context</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">callback</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #79c0ff">__name__</span><span style="color: #a5d6ff">}({</span><span style="color: #e6edf3">args</span><span style="color: #a5d6ff">}, {</span><span style="color: #e6edf3">kwargs</span><span style="color: #a5d6ff">})"</span>
        <span style="color: #e6edf3">retries</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #a5d6ff">0</span>
        <span style="color: #ff7b72">while</span> <span style="color: #ff7b72; font-weight: bold">not</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_shutdown_status:</span>
            <span style="color: #ff7b72">try</span><span style="color: #e6edf3">:</span>
                <span style="color: #ff7b72">return</span> <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">wait_for(callback(</span><span style="color: #ff7b72; font-weight: bold">*</span><span style="color: #e6edf3">args,</span> <span style="color: #ff7b72; font-weight: bold">**</span><span style="color: #e6edf3">kwargs),</span> <span style="color: #e6edf3">timeout</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #e6edf3">interval)</span>
            <span style="color: #ff7b72">except</span> <span style="color: #e6edf3">(</span><span style="color: #f0883e; font-weight: bold">TimeoutError</span><span style="color: #e6edf3">,</span> <span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">exceptions</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">TimeoutError):</span>
                <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: Timeout after {</span><span style="color: #e6edf3">interval</span><span style="color: #a5d6ff">:,} seconds {</span><span style="color: #e6edf3">context</span><span style="color: #a5d6ff">}, retrying..."</span><span style="color: #e6edf3">)</span>
                <span style="color: #e6edf3">retries</span> <span style="color: #ff7b72; font-weight: bold">+=</span> <span style="color: #a5d6ff">1</span>
                <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">max_retries</span> <span style="color: #ff7b72; font-weight: bold">is</span> <span style="color: #ff7b72; font-weight: bold">not</span> <span style="color: #79c0ff">None</span> <span style="color: #ff7b72; font-weight: bold">and</span> <span style="color: #e6edf3">retries</span> <span style="color: #ff7b72; font-weight: bold">&gt;</span> <span style="color: #e6edf3">max_retries:</span>
                    <span style="color: #ff7b72">raise</span> <span style="color: #f0883e; font-weight: bold">TimeoutError</span><span style="color: #e6edf3">(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"Timed out after {</span><span style="color: #e6edf3">(max_retries</span><span style="color: #ff7b72; font-weight: bold">+</span><span style="color: #a5d6ff">1</span><span style="color: #e6edf3">)</span><span style="color: #ff7b72; font-weight: bold">*</span><span style="color: #e6edf3">interval</span><span style="color: #a5d6ff">:,} seconds {</span><span style="color: #e6edf3">context</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>

    <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">engine_debug</span><span style="color: #e6edf3">(self,</span> <span style="color: #ff7b72; font-weight: bold">*</span><span style="color: #e6edf3">args,</span> <span style="color: #ff7b72; font-weight: bold">**</span><span style="color: #e6edf3">kwargs):</span>
        <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_engine_debug:</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">trace(</span><span style="color: #ff7b72; font-weight: bold">*</span><span style="color: #e6edf3">args,</span> <span style="color: #ff7b72; font-weight: bold">**</span><span style="color: #e6edf3">kwargs)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h1 class="doc doc-heading" id="bbot.core.engine.EngineClient">
<span class="doc doc-object-name doc-class-name">EngineClient</span>
</h1>
<div class="doc doc-contents first">
<p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="bbot.core.engine.EngineBase" href="#bbot.core.engine.EngineBase">EngineBase</a></code></p>
<p>The client portion of BBOT's RPC Engine.</p>
<p>To create an engine, you must create a subclass of this class and also
define methods for each of your desired functions.</p>
<p>Note that this only supports async functions. If you need to offload a synchronous function to another CPU, use BBOT's multiprocessing pool instead.</p>
<p>Any CPU or I/O intense logic should be implemented in the EngineServer.</p>
<p>These functions are typically stubs whose only job is to forward the arguments to the server.</p>
<p>Functions with the same names should be defined on the EngineServer.</p>
<p>The EngineClient must specify its associated server class via the <code>SERVER_CLASS</code> variable.</p>
<p>Depending on whether your function is a generator, you will use either <code>run_and_return()</code>, or <code>run_and_yield</code>.</p>
<p><span class="doc-section-title">Examples:</span></p>
<div class="highlight" style="background: #0d1117"><pre style="line-height: 125%;"><span></span><code><span style="color: #8b949e">&gt;&gt;&gt; </span><span style="color: #ff7b72">from</span> <span style="color: #ff7b72">bbot.core.engine</span> <span style="color: #ff7b72">import</span> <span style="color: #e6edf3">EngineClient</span>
<span style="color: #8b949e">&gt;&gt;&gt;</span>
<span style="color: #8b949e">&gt;&gt;&gt; </span><span style="color: #ff7b72">class</span> <span style="color: #f0883e; font-weight: bold">MyClient</span><span style="color: #e6edf3">(EngineClient):</span>
<span style="color: #8b949e">&gt;&gt;&gt; </span>    <span style="color: #e6edf3">SERVER_CLASS</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">MyServer</span>
<span style="color: #8b949e">&gt;&gt;&gt;</span>
<span style="color: #8b949e">&gt;&gt;&gt; </span>    <span style="color: #ff7b72">async</span> <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">my_function</span><span style="color: #e6edf3">(self,</span> <span style="color: #ff7b72; font-weight: bold">**</span><span style="color: #e6edf3">kwargs)</span>
<span style="color: #8b949e">&gt;&gt;&gt; </span>        <span style="color: #ff7b72">return</span> <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">run_and_return(</span><span style="color: #a5d6ff">"my_function"</span><span style="color: #e6edf3">,</span> <span style="color: #ff7b72; font-weight: bold">**</span><span style="color: #e6edf3">kwargs)</span>
<span style="color: #8b949e">&gt;&gt;&gt;</span>
<span style="color: #8b949e">&gt;&gt;&gt; </span>    <span style="color: #ff7b72">async</span> <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">my_generator</span><span style="color: #e6edf3">(self,</span> <span style="color: #ff7b72; font-weight: bold">**</span><span style="color: #e6edf3">kwargs):</span>
<span style="color: #8b949e">&gt;&gt;&gt; </span>        <span style="color: #ff7b72">async</span> <span style="color: #ff7b72">for</span> <span style="color: #e6edf3">_</span> <span style="color: #ff7b72; font-weight: bold">in</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">run_and_yield(</span><span style="color: #a5d6ff">"my_generator"</span><span style="color: #e6edf3">,</span> <span style="color: #ff7b72; font-weight: bold">**</span><span style="color: #e6edf3">kwargs):</span>
<span style="color: #8b949e">&gt;&gt;&gt; </span>            <span style="color: #ff7b72">yield</span> <span style="color: #e6edf3">_</span>
</code></pre></div>
<details class="quote">
<summary>Source code in <code>bbot/core/engine.py</code></summary>
<div class="highlight" style="background: #0d1117"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;"> 87</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;"> 88</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;"> 89</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;"> 90</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;"> 91</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;"> 92</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;"> 93</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;"> 94</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;"> 95</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;"> 96</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;"> 97</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;"> 98</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;"> 99</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">100</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">101</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">102</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">103</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">104</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">105</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">106</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">107</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">108</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">109</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">110</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">111</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">112</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">113</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">114</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">115</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">116</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">117</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">118</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">119</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">120</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">121</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">122</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">123</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">124</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">125</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">126</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">127</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">128</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">129</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">130</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">131</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">132</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">133</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">134</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">135</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">136</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">137</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">138</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">139</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">140</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">141</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">142</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">143</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">144</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">145</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">146</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">147</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">148</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">149</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">150</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">151</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">152</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">153</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">154</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">155</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">156</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">157</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">158</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">159</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">160</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">161</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">162</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">163</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">164</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">165</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">166</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">167</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">168</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">169</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">170</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">171</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">172</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">173</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">174</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">175</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">176</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">177</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">178</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">179</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">180</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">181</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">182</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">183</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">184</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">185</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">186</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">187</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">188</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">189</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">190</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">191</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">192</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">193</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">194</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">195</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">196</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">197</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">198</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">199</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">200</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">201</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">202</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">203</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">204</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">205</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">206</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">207</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">208</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">209</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">210</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">211</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">212</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">213</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">214</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">215</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">216</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">217</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">218</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">219</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">220</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">221</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">222</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">223</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">224</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">225</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">226</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">227</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">228</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">229</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">230</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">231</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">232</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">233</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">234</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">235</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">236</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">237</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">238</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">239</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">240</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">241</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">242</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">243</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">244</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">245</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">246</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">247</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">248</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">249</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">250</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">251</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">252</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">253</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">254</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">255</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">256</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">257</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">258</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">259</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">260</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">261</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">262</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">263</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">264</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">265</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">266</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">267</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">268</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">269</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">270</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">271</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">272</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">273</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">274</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">275</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">276</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">277</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">278</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">279</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">280</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">281</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">282</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">283</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">284</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">285</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">286</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">287</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">288</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">289</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">290</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">291</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">292</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">293</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">294</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">295</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">296</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">297</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">298</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">299</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">300</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">301</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">302</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">303</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">304</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">305</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">306</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">307</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">308</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">309</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">310</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">311</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">312</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">313</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">314</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">315</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">316</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">317</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">318</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">319</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">320</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">321</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">322</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">323</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">324</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">325</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">326</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">327</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">328</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">329</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">330</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">331</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">332</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">333</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">334</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">335</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">336</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">337</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">338</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">339</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">340</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">341</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">342</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">343</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">344</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">345</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">346</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">347</span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><span style="color: #ff7b72">class</span> <span style="color: #f0883e; font-weight: bold">EngineClient</span><span style="color: #e6edf3">(EngineBase):</span>
<span style="color: #6e7681">    </span><span style="color: #a5d6ff">"""</span>
<span style="color: #a5d6ff">    The client portion of BBOT's RPC Engine.</span>

<span style="color: #a5d6ff">    To create an engine, you must create a subclass of this class and also</span>
<span style="color: #a5d6ff">    define methods for each of your desired functions.</span>

<span style="color: #a5d6ff">    Note that this only supports async functions. If you need to offload a synchronous function to another CPU, use BBOT's multiprocessing pool instead.</span>

<span style="color: #a5d6ff">    Any CPU or I/O intense logic should be implemented in the EngineServer.</span>

<span style="color: #a5d6ff">    These functions are typically stubs whose only job is to forward the arguments to the server.</span>

<span style="color: #a5d6ff">    Functions with the same names should be defined on the EngineServer.</span>

<span style="color: #a5d6ff">    The EngineClient must specify its associated server class via the `SERVER_CLASS` variable.</span>

<span style="color: #a5d6ff">    Depending on whether your function is a generator, you will use either `run_and_return()`, or `run_and_yield`.</span>

<span style="color: #a5d6ff">    Examples:</span>
<span style="color: #a5d6ff">        &gt;&gt;&gt; from bbot.core.engine import EngineClient</span>
<span style="color: #a5d6ff">        &gt;&gt;&gt;</span>
<span style="color: #a5d6ff">        &gt;&gt;&gt; class MyClient(EngineClient):</span>
<span style="color: #a5d6ff">        &gt;&gt;&gt;     SERVER_CLASS = MyServer</span>
<span style="color: #a5d6ff">        &gt;&gt;&gt;</span>
<span style="color: #a5d6ff">        &gt;&gt;&gt;     async def my_function(self, **kwargs)</span>
<span style="color: #a5d6ff">        &gt;&gt;&gt;         return await self.run_and_return("my_function", **kwargs)</span>
<span style="color: #a5d6ff">        &gt;&gt;&gt;</span>
<span style="color: #a5d6ff">        &gt;&gt;&gt;     async def my_generator(self, **kwargs):</span>
<span style="color: #a5d6ff">        &gt;&gt;&gt;         async for _ in self.run_and_yield("my_generator", **kwargs):</span>
<span style="color: #a5d6ff">        &gt;&gt;&gt;             yield _</span>
<span style="color: #a5d6ff">    """</span>

    <span style="color: #e6edf3">SERVER_CLASS</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #79c0ff">None</span>

    <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">__init__</span><span style="color: #e6edf3">(self,</span> <span style="color: #e6edf3">debug</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #79c0ff">False</span><span style="color: #e6edf3">,</span> <span style="color: #ff7b72; font-weight: bold">**</span><span style="color: #e6edf3">kwargs):</span>
        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"EngineClient {</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #79c0ff">__class__</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #79c0ff">__name__</span><span style="color: #a5d6ff">}"</span>
        <span style="color: #e6edf3">super()</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #d2a8ff; font-weight: bold">__init__</span><span style="color: #e6edf3">(debug</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #e6edf3">debug)</span>
        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">process</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #79c0ff">None</span>
        <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">SERVER_CLASS</span> <span style="color: #ff7b72; font-weight: bold">is</span> <span style="color: #79c0ff">None</span><span style="color: #e6edf3">:</span>
            <span style="color: #ff7b72">raise</span> <span style="color: #f0883e; font-weight: bold">ValueError</span><span style="color: #e6edf3">(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"Must set EngineClient SERVER_CLASS, {</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">SERVER_CLASS</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">CMDS</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">dict(self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">SERVER_CLASS</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">CMDS)</span>
        <span style="color: #ff7b72">for</span> <span style="color: #e6edf3">k,</span> <span style="color: #e6edf3">v</span> <span style="color: #ff7b72; font-weight: bold">in</span> <span style="color: #e6edf3">list(self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">CMDS</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">items()):</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">CMDS[v]</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">k</span>
        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">socket_address</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"zmq_{</span><span style="color: #e6edf3">rand_string(</span><span style="color: #a5d6ff">8</span><span style="color: #e6edf3">)</span><span style="color: #a5d6ff">}.sock"</span>
        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">socket_path</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">Path(tempfile</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">gettempdir())</span> <span style="color: #ff7b72; font-weight: bold">/</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">socket_address</span>
        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">server_kwargs</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">kwargs</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">pop(</span><span style="color: #a5d6ff">"server_kwargs"</span><span style="color: #e6edf3">,</span> <span style="color: #e6edf3">{})</span>
        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_server_process</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #79c0ff">None</span>
        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">context</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">zmq</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">Context()</span>
        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">context</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">setsockopt(zmq</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">LINGER,</span> <span style="color: #a5d6ff">0</span><span style="color: #e6edf3">)</span>
        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">sockets</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">set()</span>

    <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">check_error</span><span style="color: #e6edf3">(self,</span> <span style="color: #e6edf3">message):</span>
        <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">isinstance(message,</span> <span style="color: #e6edf3">dict)</span> <span style="color: #ff7b72; font-weight: bold">and</span> <span style="color: #e6edf3">len(message)</span> <span style="color: #ff7b72; font-weight: bold">==</span> <span style="color: #a5d6ff">1</span> <span style="color: #ff7b72; font-weight: bold">and</span> <span style="color: #a5d6ff">"_e"</span> <span style="color: #ff7b72; font-weight: bold">in</span> <span style="color: #e6edf3">message:</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: got error message: {</span><span style="color: #e6edf3">message</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
            <span style="color: #e6edf3">error,</span> <span style="color: #e6edf3">trace</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">message[</span><span style="color: #a5d6ff">"_e"</span><span style="color: #e6edf3">]</span>
            <span style="color: #e6edf3">error</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">ERROR_CLASS(error)</span>
            <span style="color: #e6edf3">error</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_traceback</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">trace</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: raising {</span><span style="color: #e6edf3">error</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #79c0ff">__class__</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #79c0ff">__name__</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
            <span style="color: #ff7b72">raise</span> <span style="color: #e6edf3">error</span>
        <span style="color: #ff7b72">return</span> <span style="color: #79c0ff">False</span>

    <span style="color: #ff7b72">async</span> <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">run_and_return</span><span style="color: #e6edf3">(self,</span> <span style="color: #e6edf3">command,</span> <span style="color: #ff7b72; font-weight: bold">*</span><span style="color: #e6edf3">args,</span> <span style="color: #ff7b72; font-weight: bold">**</span><span style="color: #e6edf3">kwargs):</span>
        <span style="color: #e6edf3">fn_str</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">command</span><span style="color: #a5d6ff">}({</span><span style="color: #e6edf3">args</span><span style="color: #a5d6ff">}, {</span><span style="color: #e6edf3">kwargs</span><span style="color: #a5d6ff">})"</span>
        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: executing run-and-return {</span><span style="color: #e6edf3">fn_str</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
        <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_shutdown_status</span> <span style="color: #ff7b72; font-weight: bold">and</span> <span style="color: #ff7b72; font-weight: bold">not</span> <span style="color: #e6edf3">command</span> <span style="color: #ff7b72; font-weight: bold">==</span> <span style="color: #a5d6ff">"_shutdown"</span><span style="color: #e6edf3">:</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">verbose(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">} has been shut down and is not accepting new tasks"</span><span style="color: #e6edf3">)</span>
            <span style="color: #ff7b72">return</span>
        <span style="color: #ff7b72">async</span> <span style="color: #ff7b72">with</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">new_socket()</span> <span style="color: #ff7b72">as</span> <span style="color: #e6edf3">socket:</span>
            <span style="color: #ff7b72">try</span><span style="color: #e6edf3">:</span>
                <span style="color: #e6edf3">message</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">make_message(command,</span> <span style="color: #e6edf3">args</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #e6edf3">args,</span> <span style="color: #e6edf3">kwargs</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #e6edf3">kwargs)</span>
                <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">message</span> <span style="color: #ff7b72; font-weight: bold">is</span> <span style="color: #e6edf3">error_sentinel:</span>
                    <span style="color: #ff7b72">return</span>
                <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">socket</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">send(message)</span>
                <span style="color: #e6edf3">binary</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_infinite_retry(socket</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">recv,</span> <span style="color: #e6edf3">_context</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"waiting for return value from {</span><span style="color: #e6edf3">fn_str</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
            <span style="color: #ff7b72">except</span> <span style="color: #f0883e; font-weight: bold">BaseException</span><span style="color: #e6edf3">:</span>
                <span style="color: #ff7b72">try</span><span style="color: #e6edf3">:</span>
                    <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">send_cancel_message(socket,</span> <span style="color: #e6edf3">fn_str)</span>
                <span style="color: #ff7b72">except</span> <span style="color: #f0883e; font-weight: bold">Exception</span><span style="color: #e6edf3">:</span>
                    <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: {</span><span style="color: #e6edf3">fn_str</span><span style="color: #a5d6ff">} failed to send cancel message after exception"</span><span style="color: #e6edf3">)</span>
                    <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">trace(traceback</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">format_exc())</span>
                <span style="color: #ff7b72">raise</span>
        <span style="color: #8b949e; font-style: italic"># self.log.debug(f"{self.name}.{command}({kwargs}) got binary: {binary}")</span>
        <span style="color: #e6edf3">message</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">unpickle(binary)</span>
        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: {</span><span style="color: #e6edf3">fn_str</span><span style="color: #a5d6ff">} got return value: {</span><span style="color: #e6edf3">message</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
        <span style="color: #8b949e; font-style: italic"># error handling</span>
        <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">check_error(message):</span>
            <span style="color: #ff7b72">return</span>
        <span style="color: #ff7b72">return</span> <span style="color: #e6edf3">message</span>

    <span style="color: #ff7b72">async</span> <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">run_and_yield</span><span style="color: #e6edf3">(self,</span> <span style="color: #e6edf3">command,</span> <span style="color: #ff7b72; font-weight: bold">*</span><span style="color: #e6edf3">args,</span> <span style="color: #ff7b72; font-weight: bold">**</span><span style="color: #e6edf3">kwargs):</span>
        <span style="color: #e6edf3">fn_str</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">command</span><span style="color: #a5d6ff">}({</span><span style="color: #e6edf3">args</span><span style="color: #a5d6ff">}, {</span><span style="color: #e6edf3">kwargs</span><span style="color: #a5d6ff">})"</span>
        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: executing run-and-yield {</span><span style="color: #e6edf3">fn_str</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
        <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_shutdown_status:</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">verbose(</span><span style="color: #a5d6ff">"Engine has been shut down and is not accepting new tasks"</span><span style="color: #e6edf3">)</span>
            <span style="color: #ff7b72">return</span>
        <span style="color: #e6edf3">message</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">make_message(command,</span> <span style="color: #e6edf3">args</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #e6edf3">args,</span> <span style="color: #e6edf3">kwargs</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #e6edf3">kwargs)</span>
        <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">message</span> <span style="color: #ff7b72; font-weight: bold">is</span> <span style="color: #e6edf3">error_sentinel:</span>
            <span style="color: #ff7b72">return</span>
        <span style="color: #ff7b72">async</span> <span style="color: #ff7b72">with</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">new_socket()</span> <span style="color: #ff7b72">as</span> <span style="color: #e6edf3">socket:</span>
            <span style="color: #8b949e; font-style: italic"># TODO: synchronize server-side generator by limiting qsize</span>
            <span style="color: #8b949e; font-style: italic"># socket.setsockopt(zmq.RCVHWM, 1)</span>
            <span style="color: #8b949e; font-style: italic"># socket.setsockopt(zmq.SNDHWM, 1)</span>
            <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">socket</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">send(message)</span>
            <span style="color: #ff7b72">while</span> <span style="color: #a5d6ff">1</span><span style="color: #e6edf3">:</span>
                <span style="color: #ff7b72">try</span><span style="color: #e6edf3">:</span>
                    <span style="color: #e6edf3">binary</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_infinite_retry(</span>
                        <span style="color: #e6edf3">socket</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">recv,</span> <span style="color: #e6edf3">_context</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"waiting for new iteration from {</span><span style="color: #e6edf3">fn_str</span><span style="color: #a5d6ff">}"</span>
                    <span style="color: #e6edf3">)</span>
                    <span style="color: #8b949e; font-style: italic"># self.log.debug(f"{self.name}.{command}({kwargs}) got binary: {binary}")</span>
                    <span style="color: #e6edf3">message</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">unpickle(binary)</span>
                    <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: {</span><span style="color: #e6edf3">fn_str</span><span style="color: #a5d6ff">} got iteration: {</span><span style="color: #e6edf3">message</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
                    <span style="color: #8b949e; font-style: italic"># error handling</span>
                    <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">check_error(message)</span> <span style="color: #ff7b72; font-weight: bold">or</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">check_stop(message):</span>
                        <span style="color: #ff7b72">break</span>
                    <span style="color: #ff7b72">yield</span> <span style="color: #e6edf3">message</span>
                <span style="color: #ff7b72">except</span> <span style="color: #e6edf3">(</span><span style="color: #f0883e; font-weight: bold">StopAsyncIteration</span><span style="color: #e6edf3">,</span> <span style="color: #f0883e; font-weight: bold">GeneratorExit</span><span style="color: #e6edf3">)</span> <span style="color: #ff7b72">as</span> <span style="color: #e6edf3">e:</span>
                    <span style="color: #e6edf3">exc_name</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">e</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #79c0ff">__class__</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #79c0ff">__name__</span>
                    <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}.{</span><span style="color: #e6edf3">command</span><span style="color: #a5d6ff">} got {</span><span style="color: #e6edf3">exc_name</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
                    <span style="color: #ff7b72">try</span><span style="color: #e6edf3">:</span>
                        <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">send_cancel_message(socket,</span> <span style="color: #e6edf3">fn_str)</span>
                    <span style="color: #ff7b72">except</span> <span style="color: #f0883e; font-weight: bold">Exception</span><span style="color: #e6edf3">:</span>
                        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}.{</span><span style="color: #e6edf3">command</span><span style="color: #a5d6ff">} failed to send cancel message after {</span><span style="color: #e6edf3">exc_name</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
                        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">trace(traceback</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">format_exc())</span>
                    <span style="color: #ff7b72">break</span>

    <span style="color: #ff7b72">async</span> <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">send_cancel_message</span><span style="color: #e6edf3">(self,</span> <span style="color: #e6edf3">socket,</span> <span style="color: #e6edf3">context):</span>
<span style="color: #6e7681">        </span><span style="color: #a5d6ff">"""</span>
<span style="color: #a5d6ff">        Send a cancel message and wait for confirmation from the server</span>
<span style="color: #a5d6ff">        """</span>
        <span style="color: #8b949e; font-style: italic"># -1 == special "cancel" signal</span>
        <span style="color: #e6edf3">message</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">pickle</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">dumps({</span><span style="color: #a5d6ff">"c"</span><span style="color: #e6edf3">:</span> <span style="color: #ff7b72; font-weight: bold">-</span><span style="color: #a5d6ff">1</span><span style="color: #e6edf3">})</span>
        <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_infinite_retry(socket</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">send,</span> <span style="color: #e6edf3">message)</span>
        <span style="color: #ff7b72">while</span> <span style="color: #a5d6ff">1</span><span style="color: #e6edf3">:</span>
            <span style="color: #e6edf3">response</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_infinite_retry(</span>
                <span style="color: #e6edf3">socket</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">recv,</span> <span style="color: #e6edf3">_context</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"waiting for CANCEL_OK from {</span><span style="color: #e6edf3">context</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">,</span> <span style="color: #e6edf3">_max_retries</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #a5d6ff">4</span>
            <span style="color: #e6edf3">)</span>
            <span style="color: #e6edf3">response</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">pickle</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">loads(response)</span>
            <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">isinstance(response,</span> <span style="color: #e6edf3">dict):</span>
                <span style="color: #e6edf3">response</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">response</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">get(</span><span style="color: #a5d6ff">"m"</span><span style="color: #e6edf3">,</span> <span style="color: #a5d6ff">""</span><span style="color: #e6edf3">)</span>
                <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">response</span> <span style="color: #ff7b72; font-weight: bold">==</span> <span style="color: #a5d6ff">"CANCEL_OK"</span><span style="color: #e6edf3">:</span>
                    <span style="color: #ff7b72">break</span>

    <span style="color: #ff7b72">async</span> <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">send_shutdown_message</span><span style="color: #e6edf3">(self):</span>
        <span style="color: #ff7b72">async</span> <span style="color: #ff7b72">with</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">new_socket()</span> <span style="color: #ff7b72">as</span> <span style="color: #e6edf3">socket:</span>
            <span style="color: #8b949e; font-style: italic"># -99 == special shutdown message</span>
            <span style="color: #e6edf3">message</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">pickle</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">dumps({</span><span style="color: #a5d6ff">"c"</span><span style="color: #e6edf3">:</span> <span style="color: #ff7b72; font-weight: bold">-</span><span style="color: #a5d6ff">99</span><span style="color: #e6edf3">})</span>
            <span style="color: #ff7b72">with</span> <span style="color: #e6edf3">suppress(</span><span style="color: #f0883e; font-weight: bold">TimeoutError</span><span style="color: #e6edf3">,</span> <span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">exceptions</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">TimeoutError):</span>
                <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">wait_for(socket</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">send(message),</span> <span style="color: #a5d6ff">0.5</span><span style="color: #e6edf3">)</span>
            <span style="color: #ff7b72">with</span> <span style="color: #e6edf3">suppress(</span><span style="color: #f0883e; font-weight: bold">TimeoutError</span><span style="color: #e6edf3">,</span> <span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">exceptions</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">TimeoutError):</span>
                <span style="color: #ff7b72">while</span> <span style="color: #a5d6ff">1</span><span style="color: #e6edf3">:</span>
                    <span style="color: #e6edf3">response</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">wait_for(socket</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">recv(),</span> <span style="color: #a5d6ff">0.5</span><span style="color: #e6edf3">)</span>
                    <span style="color: #e6edf3">response</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">pickle</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">loads(response)</span>
                    <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">isinstance(response,</span> <span style="color: #e6edf3">dict):</span>
                        <span style="color: #e6edf3">response</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">response</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">get(</span><span style="color: #a5d6ff">"m"</span><span style="color: #e6edf3">,</span> <span style="color: #a5d6ff">""</span><span style="color: #e6edf3">)</span>
                        <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">response</span> <span style="color: #ff7b72; font-weight: bold">==</span> <span style="color: #a5d6ff">"SHUTDOWN_OK"</span><span style="color: #e6edf3">:</span>
                            <span style="color: #ff7b72">break</span>

    <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">check_stop</span><span style="color: #e6edf3">(self,</span> <span style="color: #e6edf3">message):</span>
        <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">isinstance(message,</span> <span style="color: #e6edf3">dict)</span> <span style="color: #ff7b72; font-weight: bold">and</span> <span style="color: #e6edf3">len(message)</span> <span style="color: #ff7b72; font-weight: bold">==</span> <span style="color: #a5d6ff">1</span> <span style="color: #ff7b72; font-weight: bold">and</span> <span style="color: #a5d6ff">"_s"</span> <span style="color: #ff7b72; font-weight: bold">in</span> <span style="color: #e6edf3">message:</span>
            <span style="color: #ff7b72">return</span> <span style="color: #79c0ff">True</span>
        <span style="color: #ff7b72">return</span> <span style="color: #79c0ff">False</span>

    <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">make_message</span><span style="color: #e6edf3">(self,</span> <span style="color: #e6edf3">command,</span> <span style="color: #e6edf3">args</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #79c0ff">None</span><span style="color: #e6edf3">,</span> <span style="color: #e6edf3">kwargs</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #79c0ff">None</span><span style="color: #e6edf3">):</span>
        <span style="color: #ff7b72">try</span><span style="color: #e6edf3">:</span>
            <span style="color: #e6edf3">cmd_id</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">CMDS[command]</span>
        <span style="color: #ff7b72">except</span> <span style="color: #f0883e; font-weight: bold">KeyError</span><span style="color: #e6edf3">:</span>
            <span style="color: #ff7b72">raise</span> <span style="color: #f0883e; font-weight: bold">KeyError</span><span style="color: #e6edf3">(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">'Command "{</span><span style="color: #e6edf3">command</span><span style="color: #a5d6ff">}" not found. Available commands: {","</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">join(self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">available_commands)</span><span style="color: #a5d6ff">}'</span><span style="color: #e6edf3">)</span>
        <span style="color: #e6edf3">message</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">{</span><span style="color: #a5d6ff">"c"</span><span style="color: #e6edf3">:</span> <span style="color: #e6edf3">cmd_id}</span>
        <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">args:</span>
            <span style="color: #e6edf3">message[</span><span style="color: #a5d6ff">"a"</span><span style="color: #e6edf3">]</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">args</span>
        <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">kwargs:</span>
            <span style="color: #e6edf3">message[</span><span style="color: #a5d6ff">"k"</span><span style="color: #e6edf3">]</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">kwargs</span>
        <span style="color: #ff7b72">return</span> <span style="color: #e6edf3">pickle</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">dumps(message)</span>

    <span style="color: #d2a8ff; font-weight: bold">@property</span>
    <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">available_commands</span><span style="color: #e6edf3">(self):</span>
        <span style="color: #ff7b72">return</span> <span style="color: #e6edf3">[s</span> <span style="color: #ff7b72">for</span> <span style="color: #e6edf3">s</span> <span style="color: #ff7b72; font-weight: bold">in</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">CMDS</span> <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">isinstance(s,</span> <span style="color: #e6edf3">str)]</span>

    <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">start_server</span><span style="color: #e6edf3">(self):</span>
        <span style="color: #ff7b72">import</span> <span style="color: #ff7b72">multiprocessing</span>

        <span style="color: #e6edf3">process_name</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">multiprocessing</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">current_process()</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span>
        <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">process_name</span> <span style="color: #ff7b72; font-weight: bold">==</span> <span style="color: #a5d6ff">"MainProcess"</span><span style="color: #e6edf3">:</span>
            <span style="color: #e6edf3">kwargs</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">dict(self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">server_kwargs)</span>
            <span style="color: #8b949e; font-style: italic"># if we're in tests, we use a single event loop to avoid weird race conditions</span>
            <span style="color: #8b949e; font-style: italic"># this allows us to more easily mock http, etc.</span>
            <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">os</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">environ</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">get(</span><span style="color: #a5d6ff">"BBOT_TESTING"</span><span style="color: #e6edf3">,</span> <span style="color: #a5d6ff">""</span><span style="color: #e6edf3">)</span> <span style="color: #ff7b72; font-weight: bold">==</span> <span style="color: #a5d6ff">"True"</span><span style="color: #e6edf3">:</span>
                <span style="color: #e6edf3">kwargs[</span><span style="color: #a5d6ff">"_loop"</span><span style="color: #e6edf3">]</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">get_event_loop()</span>
            <span style="color: #e6edf3">kwargs[</span><span style="color: #a5d6ff">"debug"</span><span style="color: #e6edf3">]</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_engine_debug</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">process</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">CORE</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">create_process(</span>
                <span style="color: #e6edf3">target</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">server_process,</span>
                <span style="color: #e6edf3">args</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #e6edf3">(</span>
                    <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">SERVER_CLASS,</span>
                    <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">socket_path,</span>
                <span style="color: #e6edf3">),</span>
                <span style="color: #e6edf3">kwargs</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #e6edf3">kwargs,</span>
                <span style="color: #e6edf3">custom_name</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"BBOT {</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #79c0ff">__class__</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #79c0ff">__name__</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">,</span>
            <span style="color: #e6edf3">)</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">process</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">start()</span>
            <span style="color: #ff7b72">return</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">process</span>
        <span style="color: #ff7b72">else</span><span style="color: #e6edf3">:</span>
            <span style="color: #ff7b72">raise</span> <span style="color: #e6edf3">BBOTEngineError(</span>
                <span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"Tried to start server from process {</span><span style="color: #e6edf3">process_name</span><span style="color: #a5d6ff">}. Did you forget </span><span style="color: #79c0ff">\"</span><span style="color: #a5d6ff">if __name__ == '__main__'?</span><span style="color: #79c0ff">\"</span><span style="color: #a5d6ff">"</span>
            <span style="color: #e6edf3">)</span>

    <span style="color: #d2a8ff; font-weight: bold">@staticmethod</span>
    <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">server_process</span><span style="color: #e6edf3">(server_class,</span> <span style="color: #e6edf3">socket_path,</span> <span style="color: #ff7b72; font-weight: bold">**</span><span style="color: #e6edf3">kwargs):</span>
        <span style="color: #ff7b72">try</span><span style="color: #e6edf3">:</span>
            <span style="color: #e6edf3">loop</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">kwargs</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">pop(</span><span style="color: #a5d6ff">"_loop"</span><span style="color: #e6edf3">,</span> <span style="color: #79c0ff">None</span><span style="color: #e6edf3">)</span>
            <span style="color: #e6edf3">engine_server</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">server_class(socket_path,</span> <span style="color: #ff7b72; font-weight: bold">**</span><span style="color: #e6edf3">kwargs)</span>
            <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">loop</span> <span style="color: #ff7b72; font-weight: bold">is</span> <span style="color: #ff7b72; font-weight: bold">not</span> <span style="color: #79c0ff">None</span><span style="color: #e6edf3">:</span>
                <span style="color: #e6edf3">future</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">run_coroutine_threadsafe(engine_server</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">worker(),</span> <span style="color: #e6edf3">loop)</span>
                <span style="color: #e6edf3">future</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">result()</span>
            <span style="color: #ff7b72">else</span><span style="color: #e6edf3">:</span>
                <span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">run(engine_server</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">worker())</span>
        <span style="color: #ff7b72">except</span> <span style="color: #e6edf3">(asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">CancelledError,</span> <span style="color: #f0883e; font-weight: bold">KeyboardInterrupt</span><span style="color: #e6edf3">,</span> <span style="color: #e6edf3">CancelledError):</span>
            <span style="color: #ff7b72">return</span>
        <span style="color: #ff7b72">except</span> <span style="color: #f0883e; font-weight: bold">Exception</span><span style="color: #e6edf3">:</span>
            <span style="color: #ff7b72">import</span> <span style="color: #ff7b72">traceback</span>

            <span style="color: #e6edf3">log</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">logging</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">getLogger(</span><span style="color: #a5d6ff">"bbot.core.engine.server"</span><span style="color: #e6edf3">)</span>
            <span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">critical(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"Unhandled error in {</span><span style="color: #e6edf3">server_class</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #79c0ff">__name__</span><span style="color: #a5d6ff">} server process: {</span><span style="color: #e6edf3">traceback</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">format_exc()</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>

    <span style="color: #d2a8ff; font-weight: bold">@asynccontextmanager</span>
    <span style="color: #ff7b72">async</span> <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">new_socket</span><span style="color: #e6edf3">(self):</span>
        <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_server_process</span> <span style="color: #ff7b72; font-weight: bold">is</span> <span style="color: #79c0ff">None</span><span style="color: #e6edf3">:</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_server_process</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">start_server()</span>
            <span style="color: #ff7b72">while</span> <span style="color: #ff7b72; font-weight: bold">not</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">socket_path</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">exists():</span>
                <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: waiting for server process to start..."</span><span style="color: #e6edf3">)</span>
                <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">sleep(</span><span style="color: #a5d6ff">0.1</span><span style="color: #e6edf3">)</span>
        <span style="color: #e6edf3">socket</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">context</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">socket(zmq</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">DEALER)</span>
        <span style="color: #e6edf3">socket</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">setsockopt(zmq</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">LINGER,</span> <span style="color: #a5d6ff">0</span><span style="color: #e6edf3">)</span>  <span style="color: #8b949e; font-style: italic"># Discard pending messages immediately disconnect() or close()</span>
        <span style="color: #e6edf3">socket</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">setsockopt(zmq</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">SNDHWM,</span> <span style="color: #a5d6ff">0</span><span style="color: #e6edf3">)</span>  <span style="color: #8b949e; font-style: italic"># Unlimited send buffer</span>
        <span style="color: #e6edf3">socket</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">setsockopt(zmq</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">RCVHWM,</span> <span style="color: #a5d6ff">0</span><span style="color: #e6edf3">)</span>  <span style="color: #8b949e; font-style: italic"># Unlimited receive buffer</span>
        <span style="color: #e6edf3">socket</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">connect(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"ipc://{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">socket_path</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">sockets</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">add(socket)</span>
        <span style="color: #ff7b72">try</span><span style="color: #e6edf3">:</span>
            <span style="color: #ff7b72">yield</span> <span style="color: #e6edf3">socket</span>
        <span style="color: #ff7b72">finally</span><span style="color: #e6edf3">:</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">sockets</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">remove(socket)</span>
            <span style="color: #ff7b72">with</span> <span style="color: #e6edf3">suppress(</span><span style="color: #f0883e; font-weight: bold">Exception</span><span style="color: #e6edf3">):</span>
                <span style="color: #e6edf3">socket</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">close()</span>

    <span style="color: #ff7b72">async</span> <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">shutdown</span><span style="color: #e6edf3">(self):</span>
        <span style="color: #ff7b72">if</span> <span style="color: #ff7b72; font-weight: bold">not</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_shutdown_status:</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_shutdown_status</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #79c0ff">True</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">verbose(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: shutting down..."</span><span style="color: #e6edf3">)</span>
            <span style="color: #8b949e; font-style: italic"># send shutdown signal</span>
            <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">send_shutdown_message()</span>
            <span style="color: #8b949e; font-style: italic"># then terminate context</span>
            <span style="color: #ff7b72">try</span><span style="color: #e6edf3">:</span>
                <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">context</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">destroy(linger</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #a5d6ff">0</span><span style="color: #e6edf3">)</span>
            <span style="color: #ff7b72">except</span> <span style="color: #f0883e; font-weight: bold">Exception</span><span style="color: #e6edf3">:</span>
                <span style="color: #e6edf3">print(traceback</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">format_exc(),</span> <span style="color: #e6edf3">file</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #e6edf3">sys</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">stderr)</span>
            <span style="color: #ff7b72">try</span><span style="color: #e6edf3">:</span>
                <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">context</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">term()</span>
            <span style="color: #ff7b72">except</span> <span style="color: #f0883e; font-weight: bold">Exception</span><span style="color: #e6edf3">:</span>
                <span style="color: #e6edf3">print(traceback</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">format_exc(),</span> <span style="color: #e6edf3">file</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #e6edf3">sys</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">stderr)</span>
            <span style="color: #8b949e; font-style: italic"># delete socket file on exit</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">socket_path</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">unlink(missing_ok</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #79c0ff">True</span><span style="color: #e6edf3">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="bbot.core.engine.EngineClient.send_cancel_message">
<span class="doc doc-object-name doc-function-name">send_cancel_message</span>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-async"><code>async</code></small>
</span>
</h2>
<div class="doc-signature highlight" style="background: #0d1117"><pre style="line-height: 125%;"><span></span><code><span style="color: #e6edf3">send_cancel_message(socket,</span> <span style="color: #e6edf3">context)</span>
</code></pre></div>
<div class="doc doc-contents">
<p>Send a cancel message and wait for confirmation from the server</p>
<details class="quote">
<summary>Source code in <code>bbot/core/engine.py</code></summary>
<div class="highlight" style="background: #0d1117"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">213</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">214</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">215</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">216</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">217</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">218</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">219</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">220</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">221</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">222</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">223</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">224</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">225</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">226</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">227</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">228</span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><span style="color: #ff7b72">async</span> <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">send_cancel_message</span><span style="color: #e6edf3">(self,</span> <span style="color: #e6edf3">socket,</span> <span style="color: #e6edf3">context):</span>
<span style="color: #6e7681">    </span><span style="color: #a5d6ff">"""</span>
<span style="color: #a5d6ff">    Send a cancel message and wait for confirmation from the server</span>
<span style="color: #a5d6ff">    """</span>
    <span style="color: #8b949e; font-style: italic"># -1 == special "cancel" signal</span>
    <span style="color: #e6edf3">message</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">pickle</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">dumps({</span><span style="color: #a5d6ff">"c"</span><span style="color: #e6edf3">:</span> <span style="color: #ff7b72; font-weight: bold">-</span><span style="color: #a5d6ff">1</span><span style="color: #e6edf3">})</span>
    <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_infinite_retry(socket</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">send,</span> <span style="color: #e6edf3">message)</span>
    <span style="color: #ff7b72">while</span> <span style="color: #a5d6ff">1</span><span style="color: #e6edf3">:</span>
        <span style="color: #e6edf3">response</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_infinite_retry(</span>
            <span style="color: #e6edf3">socket</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">recv,</span> <span style="color: #e6edf3">_context</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"waiting for CANCEL_OK from {</span><span style="color: #e6edf3">context</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">,</span> <span style="color: #e6edf3">_max_retries</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #a5d6ff">4</span>
        <span style="color: #e6edf3">)</span>
        <span style="color: #e6edf3">response</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">pickle</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">loads(response)</span>
        <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">isinstance(response,</span> <span style="color: #e6edf3">dict):</span>
            <span style="color: #e6edf3">response</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">response</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">get(</span><span style="color: #a5d6ff">"m"</span><span style="color: #e6edf3">,</span> <span style="color: #a5d6ff">""</span><span style="color: #e6edf3">)</span>
            <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">response</span> <span style="color: #ff7b72; font-weight: bold">==</span> <span style="color: #a5d6ff">"CANCEL_OK"</span><span style="color: #e6edf3">:</span>
                <span style="color: #ff7b72">break</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h1 class="doc doc-heading" id="bbot.core.engine.EngineServer">
<span class="doc doc-object-name doc-class-name">EngineServer</span>
</h1>
<div class="doc doc-contents first">
<p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="bbot.core.engine.EngineBase" href="#bbot.core.engine.EngineBase">EngineBase</a></code></p>
<p>The server portion of BBOT's RPC Engine.</p>
<p>Methods defined here must match the methods in your EngineClient.</p>
<p>To use the functions, you must create mappings for them in the CMDS attribute, as shown below.</p>
<p><span class="doc-section-title">Examples:</span></p>
<div class="highlight" style="background: #0d1117"><pre style="line-height: 125%;"><span></span><code><span style="color: #8b949e">&gt;&gt;&gt; </span><span style="color: #ff7b72">from</span> <span style="color: #ff7b72">bbot.core.engine</span> <span style="color: #ff7b72">import</span> <span style="color: #e6edf3">EngineServer</span>
<span style="color: #8b949e">&gt;&gt;&gt;</span>
<span style="color: #8b949e">&gt;&gt;&gt; </span><span style="color: #ff7b72">class</span> <span style="color: #f0883e; font-weight: bold">MyServer</span><span style="color: #e6edf3">(EngineServer):</span>
<span style="color: #8b949e">&gt;&gt;&gt; </span>    <span style="color: #e6edf3">CMDS</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">{</span>
<span style="color: #8b949e">&gt;&gt;&gt; </span>        <span style="color: #a5d6ff">0</span><span style="color: #e6edf3">:</span> <span style="color: #a5d6ff">"my_function"</span><span style="color: #e6edf3">,</span>
<span style="color: #8b949e">&gt;&gt;&gt; </span>        <span style="color: #a5d6ff">1</span><span style="color: #e6edf3">:</span> <span style="color: #a5d6ff">"my_generator"</span><span style="color: #e6edf3">,</span>
<span style="color: #8b949e">&gt;&gt;&gt; </span>    <span style="color: #e6edf3">}</span>
<span style="color: #8b949e">&gt;&gt;&gt;</span>
<span style="color: #8b949e">&gt;&gt;&gt; </span>    <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">my_function</span><span style="color: #e6edf3">(self,</span> <span style="color: #e6edf3">arg1</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #79c0ff">None</span><span style="color: #e6edf3">):</span>
<span style="color: #8b949e">&gt;&gt;&gt; </span>        <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">sleep(</span><span style="color: #a5d6ff">1</span><span style="color: #e6edf3">)</span>
<span style="color: #8b949e">&gt;&gt;&gt; </span>        <span style="color: #ff7b72">return</span> <span style="color: #e6edf3">str(arg1)</span>
<span style="color: #8b949e">&gt;&gt;&gt;</span>
<span style="color: #8b949e">&gt;&gt;&gt; </span>    <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">my_generator</span><span style="color: #e6edf3">(self):</span>
<span style="color: #8b949e">&gt;&gt;&gt; </span>        <span style="color: #ff7b72">for</span> <span style="color: #e6edf3">i</span> <span style="color: #ff7b72; font-weight: bold">in</span> <span style="color: #e6edf3">range(</span><span style="color: #a5d6ff">10</span><span style="color: #e6edf3">):</span>
<span style="color: #8b949e">&gt;&gt;&gt; </span>            <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">sleep(</span><span style="color: #a5d6ff">1</span><span style="color: #e6edf3">)</span>
<span style="color: #8b949e">&gt;&gt;&gt; </span>            <span style="color: #ff7b72">yield</span> <span style="color: #e6edf3">i</span>
</code></pre></div>
<details class="quote">
<summary>Source code in <code>bbot/core/engine.py</code></summary>
<div class="highlight" style="background: #0d1117"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">350</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">351</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">352</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">353</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">354</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">355</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">356</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">357</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">358</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">359</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">360</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">361</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">362</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">363</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">364</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">365</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">366</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">367</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">368</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">369</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">370</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">371</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">372</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">373</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">374</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">375</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">376</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">377</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">378</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">379</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">380</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">381</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">382</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">383</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">384</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">385</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">386</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">387</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">388</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">389</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">390</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">391</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">392</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">393</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">394</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">395</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">396</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">397</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">398</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">399</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">400</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">401</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">402</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">403</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">404</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">405</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">406</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">407</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">408</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">409</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">410</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">411</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">412</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">413</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">414</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">415</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">416</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">417</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">418</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">419</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">420</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">421</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">422</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">423</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">424</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">425</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">426</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">427</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">428</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">429</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">430</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">431</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">432</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">433</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">434</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">435</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">436</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">437</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">438</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">439</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">440</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">441</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">442</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">443</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">444</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">445</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">446</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">447</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">448</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">449</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">450</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">451</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">452</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">453</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">454</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">455</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">456</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">457</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">458</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">459</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">460</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">461</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">462</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">463</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">464</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">465</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">466</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">467</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">468</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">469</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">470</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">471</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">472</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">473</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">474</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">475</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">476</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">477</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">478</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">479</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">480</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">481</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">482</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">483</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">484</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">485</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">486</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">487</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">488</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">489</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">490</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">491</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">492</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">493</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">494</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">495</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">496</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">497</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">498</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">499</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">500</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">501</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">502</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">503</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">504</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">505</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">506</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">507</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">508</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">509</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">510</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">511</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">512</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">513</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">514</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">515</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">516</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">517</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">518</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">519</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">520</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">521</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">522</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">523</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">524</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">525</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">526</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">527</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">528</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">529</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">530</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">531</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">532</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">533</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">534</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">535</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">536</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">537</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">538</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">539</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">540</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">541</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">542</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">543</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">544</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">545</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">546</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">547</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">548</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">549</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">550</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">551</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">552</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">553</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">554</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">555</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">556</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">557</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">558</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">559</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">560</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">561</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">562</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">563</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">564</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">565</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">566</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">567</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">568</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">569</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">570</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">571</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">572</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">573</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">574</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">575</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">576</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">577</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">578</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">579</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">580</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">581</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">582</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">583</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">584</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">585</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">586</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">587</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">588</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">589</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">590</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">591</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">592</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">593</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">594</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">595</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">596</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">597</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">598</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">599</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">600</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">601</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">602</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">603</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">604</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">605</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">606</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">607</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">608</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">609</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">610</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">611</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">612</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">613</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">614</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">615</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">616</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">617</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">618</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">619</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">620</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">621</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">622</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">623</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">624</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">625</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">626</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">627</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">628</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">629</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">630</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">631</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">632</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">633</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">634</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">635</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">636</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">637</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">638</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">639</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">640</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">641</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">642</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">643</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">644</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">645</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">646</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">647</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">648</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">649</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">650</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">651</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">652</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">653</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">654</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">655</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">656</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">657</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">658</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">659</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">660</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">661</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">662</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">663</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">664</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">665</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">666</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">667</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">668</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">669</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">670</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">671</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">672</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">673</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">674</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">675</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">676</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">677</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">678</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">679</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">680</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">681</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">682</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">683</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">684</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">685</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">686</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">687</span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><span style="color: #ff7b72">class</span> <span style="color: #f0883e; font-weight: bold">EngineServer</span><span style="color: #e6edf3">(EngineBase):</span>
<span style="color: #6e7681">    </span><span style="color: #a5d6ff">"""</span>
<span style="color: #a5d6ff">    The server portion of BBOT's RPC Engine.</span>

<span style="color: #a5d6ff">    Methods defined here must match the methods in your EngineClient.</span>

<span style="color: #a5d6ff">    To use the functions, you must create mappings for them in the CMDS attribute, as shown below.</span>

<span style="color: #a5d6ff">    Examples:</span>
<span style="color: #a5d6ff">        &gt;&gt;&gt; from bbot.core.engine import EngineServer</span>
<span style="color: #a5d6ff">        &gt;&gt;&gt;</span>
<span style="color: #a5d6ff">        &gt;&gt;&gt; class MyServer(EngineServer):</span>
<span style="color: #a5d6ff">        &gt;&gt;&gt;     CMDS = {</span>
<span style="color: #a5d6ff">        &gt;&gt;&gt;         0: "my_function",</span>
<span style="color: #a5d6ff">        &gt;&gt;&gt;         1: "my_generator",</span>
<span style="color: #a5d6ff">        &gt;&gt;&gt;     }</span>
<span style="color: #a5d6ff">        &gt;&gt;&gt;</span>
<span style="color: #a5d6ff">        &gt;&gt;&gt;     def my_function(self, arg1=None):</span>
<span style="color: #a5d6ff">        &gt;&gt;&gt;         await asyncio.sleep(1)</span>
<span style="color: #a5d6ff">        &gt;&gt;&gt;         return str(arg1)</span>
<span style="color: #a5d6ff">        &gt;&gt;&gt;</span>
<span style="color: #a5d6ff">        &gt;&gt;&gt;     def my_generator(self):</span>
<span style="color: #a5d6ff">        &gt;&gt;&gt;         for i in range(10):</span>
<span style="color: #a5d6ff">        &gt;&gt;&gt;             await asyncio.sleep(1)</span>
<span style="color: #a5d6ff">        &gt;&gt;&gt;             yield i</span>
<span style="color: #a5d6ff">    """</span>

    <span style="color: #e6edf3">CMDS</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">{}</span>

    <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">__init__</span><span style="color: #e6edf3">(self,</span> <span style="color: #e6edf3">socket_path,</span> <span style="color: #e6edf3">debug</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #79c0ff">False</span><span style="color: #e6edf3">):</span>
        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"EngineServer {</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #79c0ff">__class__</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #79c0ff">__name__</span><span style="color: #a5d6ff">}"</span>
        <span style="color: #e6edf3">super()</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #d2a8ff; font-weight: bold">__init__</span><span style="color: #e6edf3">(debug</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #e6edf3">debug)</span>
        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: finished setup 1 (_debug={</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_engine_debug</span><span style="color: #a5d6ff">})"</span><span style="color: #e6edf3">)</span>
        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">socket_path</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">socket_path</span>
        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">client_id_var</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">contextvars</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">ContextVar(</span><span style="color: #a5d6ff">"client_id"</span><span style="color: #e6edf3">,</span> <span style="color: #e6edf3">default</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #79c0ff">None</span><span style="color: #e6edf3">)</span>
        <span style="color: #8b949e; font-style: italic"># task &lt;--&gt; client id mapping</span>
        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">tasks</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">{}</span>
        <span style="color: #8b949e; font-style: italic"># child tasks spawned by main tasks</span>
        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">child_tasks</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">{}</span>
        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: finished setup 2 (_debug={</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_engine_debug</span><span style="color: #a5d6ff">})"</span><span style="color: #e6edf3">)</span>
        <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">socket_path</span> <span style="color: #ff7b72; font-weight: bold">is</span> <span style="color: #ff7b72; font-weight: bold">not</span> <span style="color: #79c0ff">None</span><span style="color: #e6edf3">:</span>
            <span style="color: #8b949e; font-style: italic"># create ZeroMQ context</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">context</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">zmq</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">Context()</span>
            <span style="color: #8b949e; font-style: italic"># ROUTER socket can handle multiple concurrent requests</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">socket</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">context</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">socket(zmq</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">ROUTER)</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">socket</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">setsockopt(zmq</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">LINGER,</span> <span style="color: #a5d6ff">0</span><span style="color: #e6edf3">)</span>  <span style="color: #8b949e; font-style: italic"># Discard pending messages immediately disconnect() or close()</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">socket</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">setsockopt(zmq</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">SNDHWM,</span> <span style="color: #a5d6ff">0</span><span style="color: #e6edf3">)</span>  <span style="color: #8b949e; font-style: italic"># Unlimited send buffer</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">socket</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">setsockopt(zmq</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">RCVHWM,</span> <span style="color: #a5d6ff">0</span><span style="color: #e6edf3">)</span>  <span style="color: #8b949e; font-style: italic"># Unlimited receive buffer</span>
            <span style="color: #8b949e; font-style: italic"># create socket file</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">socket</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">bind(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"ipc://{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">socket_path</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: finished setup 3 (_debug={</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_engine_debug</span><span style="color: #a5d6ff">})"</span><span style="color: #e6edf3">)</span>

    <span style="color: #d2a8ff; font-weight: bold">@contextlib</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">contextmanager</span>
    <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">client_id_context</span><span style="color: #e6edf3">(self,</span> <span style="color: #e6edf3">value):</span>
        <span style="color: #e6edf3">token</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">client_id_var</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">set(value)</span>
        <span style="color: #ff7b72">try</span><span style="color: #e6edf3">:</span>
            <span style="color: #ff7b72">yield</span>
        <span style="color: #ff7b72">finally</span><span style="color: #e6edf3">:</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">client_id_var</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">reset(token)</span>

    <span style="color: #ff7b72">async</span> <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">run_and_return</span><span style="color: #e6edf3">(self,</span> <span style="color: #e6edf3">client_id,</span> <span style="color: #e6edf3">command_fn,</span> <span style="color: #ff7b72; font-weight: bold">*</span><span style="color: #e6edf3">args,</span> <span style="color: #ff7b72; font-weight: bold">**</span><span style="color: #e6edf3">kwargs):</span>
        <span style="color: #e6edf3">fn_str</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">command_fn</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #79c0ff">__name__</span><span style="color: #a5d6ff">}({</span><span style="color: #e6edf3">args</span><span style="color: #a5d6ff">}, {</span><span style="color: #e6edf3">kwargs</span><span style="color: #a5d6ff">})"</span>
        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(fn_str)</span>
        <span style="color: #ff7b72">with</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">client_id_context(client_id):</span>
            <span style="color: #ff7b72">try</span><span style="color: #e6edf3">:</span>
                <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: starting run-and-return {</span><span style="color: #e6edf3">fn_str</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
                <span style="color: #ff7b72">try</span><span style="color: #e6edf3">:</span>
                    <span style="color: #e6edf3">result</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">command_fn(</span><span style="color: #ff7b72; font-weight: bold">*</span><span style="color: #e6edf3">args,</span> <span style="color: #ff7b72; font-weight: bold">**</span><span style="color: #e6edf3">kwargs)</span>
                <span style="color: #ff7b72">except</span> <span style="color: #f0883e; font-weight: bold">BaseException</span> <span style="color: #ff7b72">as</span> <span style="color: #e6edf3">e:</span>
                    <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">in_exception_chain(e,</span> <span style="color: #e6edf3">(</span><span style="color: #f0883e; font-weight: bold">KeyboardInterrupt</span><span style="color: #e6edf3">,</span> <span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">CancelledError)):</span>
                        <span style="color: #e6edf3">log_fn</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">debug</span>
                    <span style="color: #ff7b72">else</span><span style="color: #e6edf3">:</span>
                        <span style="color: #e6edf3">log_fn</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">error</span>
                    <span style="color: #e6edf3">error</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: error in {</span><span style="color: #e6edf3">fn_str</span><span style="color: #a5d6ff">}: {</span><span style="color: #e6edf3">e</span><span style="color: #a5d6ff">}"</span>
                    <span style="color: #e6edf3">trace</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">traceback</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">format_exc()</span>
                    <span style="color: #e6edf3">log_fn(error)</span>
                    <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">trace(trace)</span>
                    <span style="color: #e6edf3">result</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">{</span><span style="color: #a5d6ff">"_e"</span><span style="color: #e6edf3">:</span> <span style="color: #e6edf3">(error,</span> <span style="color: #e6edf3">trace)}</span>
                <span style="color: #ff7b72">finally</span><span style="color: #e6edf3">:</span>
                    <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">tasks</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">pop(client_id,</span> <span style="color: #79c0ff">None</span><span style="color: #e6edf3">)</span>
                    <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: sending response to {</span><span style="color: #e6edf3">fn_str</span><span style="color: #a5d6ff">}: {</span><span style="color: #e6edf3">result</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
                    <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">send_socket_multipart(client_id,</span> <span style="color: #e6edf3">result)</span>
            <span style="color: #ff7b72">except</span> <span style="color: #f0883e; font-weight: bold">BaseException</span> <span style="color: #ff7b72">as</span> <span style="color: #e6edf3">e:</span>
                <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">critical(</span>
                    <span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"Unhandled exception in {</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}.run_and_return({</span><span style="color: #e6edf3">client_id</span><span style="color: #a5d6ff">}, {</span><span style="color: #e6edf3">command_fn</span><span style="color: #a5d6ff">}, {</span><span style="color: #e6edf3">args</span><span style="color: #a5d6ff">}, {</span><span style="color: #e6edf3">kwargs</span><span style="color: #a5d6ff">}): {</span><span style="color: #e6edf3">e</span><span style="color: #a5d6ff">}"</span>
                <span style="color: #e6edf3">)</span>
                <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">critical(traceback</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">format_exc())</span>
            <span style="color: #ff7b72">finally</span><span style="color: #e6edf3">:</span>
                <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">} finished run-and-return {</span><span style="color: #e6edf3">fn_str</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>

    <span style="color: #ff7b72">async</span> <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">run_and_yield</span><span style="color: #e6edf3">(self,</span> <span style="color: #e6edf3">client_id,</span> <span style="color: #e6edf3">command_fn,</span> <span style="color: #ff7b72; font-weight: bold">*</span><span style="color: #e6edf3">args,</span> <span style="color: #ff7b72; font-weight: bold">**</span><span style="color: #e6edf3">kwargs):</span>
        <span style="color: #e6edf3">fn_str</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">command_fn</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #79c0ff">__name__</span><span style="color: #a5d6ff">}({</span><span style="color: #e6edf3">args</span><span style="color: #a5d6ff">}, {</span><span style="color: #e6edf3">kwargs</span><span style="color: #a5d6ff">})"</span>
        <span style="color: #ff7b72">with</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">client_id_context(client_id):</span>
            <span style="color: #ff7b72">try</span><span style="color: #e6edf3">:</span>
                <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: starting run-and-yield {</span><span style="color: #e6edf3">fn_str</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
                <span style="color: #ff7b72">try</span><span style="color: #e6edf3">:</span>
                    <span style="color: #ff7b72">async</span> <span style="color: #ff7b72">for</span> <span style="color: #e6edf3">_</span> <span style="color: #ff7b72; font-weight: bold">in</span> <span style="color: #e6edf3">command_fn(</span><span style="color: #ff7b72; font-weight: bold">*</span><span style="color: #e6edf3">args,</span> <span style="color: #ff7b72; font-weight: bold">**</span><span style="color: #e6edf3">kwargs):</span>
                        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: sending iteration for {</span><span style="color: #e6edf3">fn_str</span><span style="color: #a5d6ff">}: {</span><span style="color: #e6edf3">_</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
                        <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">send_socket_multipart(client_id,</span> <span style="color: #e6edf3">_)</span>
                <span style="color: #ff7b72">except</span> <span style="color: #f0883e; font-weight: bold">BaseException</span> <span style="color: #ff7b72">as</span> <span style="color: #e6edf3">e:</span>
                    <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">in_exception_chain(e,</span> <span style="color: #e6edf3">(</span><span style="color: #f0883e; font-weight: bold">KeyboardInterrupt</span><span style="color: #e6edf3">,</span> <span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">CancelledError)):</span>
                        <span style="color: #e6edf3">log_fn</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">debug</span>
                    <span style="color: #ff7b72">else</span><span style="color: #e6edf3">:</span>
                        <span style="color: #e6edf3">log_fn</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">error</span>
                    <span style="color: #e6edf3">error</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: error in {</span><span style="color: #e6edf3">fn_str</span><span style="color: #a5d6ff">}: {</span><span style="color: #e6edf3">e</span><span style="color: #a5d6ff">}"</span>
                    <span style="color: #e6edf3">trace</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">traceback</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">format_exc()</span>
                    <span style="color: #e6edf3">log_fn(error)</span>
                    <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">trace(trace)</span>
                    <span style="color: #e6edf3">result</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">{</span><span style="color: #a5d6ff">"_e"</span><span style="color: #e6edf3">:</span> <span style="color: #e6edf3">(error,</span> <span style="color: #e6edf3">trace)}</span>
                    <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">send_socket_multipart(client_id,</span> <span style="color: #e6edf3">result)</span>
                <span style="color: #ff7b72">finally</span><span style="color: #e6edf3">:</span>
                    <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: reached end of run-and-yield iteration for {</span><span style="color: #e6edf3">fn_str</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
                    <span style="color: #8b949e; font-style: italic"># _s == special signal that means StopIteration</span>
                    <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">send_socket_multipart(client_id,</span> <span style="color: #e6edf3">{</span><span style="color: #a5d6ff">"_s"</span><span style="color: #e6edf3">:</span> <span style="color: #79c0ff">None</span><span style="color: #e6edf3">})</span>
                    <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">tasks</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">pop(client_id,</span> <span style="color: #79c0ff">None</span><span style="color: #e6edf3">)</span>
            <span style="color: #ff7b72">except</span> <span style="color: #f0883e; font-weight: bold">BaseException</span> <span style="color: #ff7b72">as</span> <span style="color: #e6edf3">e:</span>
                <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">critical(</span>
                    <span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"Unhandled exception in {</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}.run_and_yield({</span><span style="color: #e6edf3">client_id</span><span style="color: #a5d6ff">}, {</span><span style="color: #e6edf3">command_fn</span><span style="color: #a5d6ff">}, {</span><span style="color: #e6edf3">args</span><span style="color: #a5d6ff">}, {</span><span style="color: #e6edf3">kwargs</span><span style="color: #a5d6ff">}): {</span><span style="color: #e6edf3">e</span><span style="color: #a5d6ff">}"</span>
                <span style="color: #e6edf3">)</span>
                <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">critical(traceback</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">format_exc())</span>
            <span style="color: #ff7b72">finally</span><span style="color: #e6edf3">:</span>
                <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: finished run-and-yield {</span><span style="color: #e6edf3">fn_str</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>

    <span style="color: #ff7b72">async</span> <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">send_socket_multipart</span><span style="color: #e6edf3">(self,</span> <span style="color: #e6edf3">client_id,</span> <span style="color: #e6edf3">message):</span>
        <span style="color: #ff7b72">try</span><span style="color: #e6edf3">:</span>
            <span style="color: #e6edf3">message</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">pickle</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">dumps(message)</span>
            <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_infinite_retry(self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">socket</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">send_multipart,</span> <span style="color: #e6edf3">[client_id,</span> <span style="color: #e6edf3">message])</span>
        <span style="color: #ff7b72">except</span> <span style="color: #f0883e; font-weight: bold">Exception</span> <span style="color: #ff7b72">as</span> <span style="color: #e6edf3">e:</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">verbose(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: error sending ZMQ message: {</span><span style="color: #e6edf3">e</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">trace(traceback</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">format_exc())</span>

    <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">check_error</span><span style="color: #e6edf3">(self,</span> <span style="color: #e6edf3">message):</span>
        <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">message</span> <span style="color: #ff7b72; font-weight: bold">is</span> <span style="color: #e6edf3">error_sentinel:</span>
            <span style="color: #ff7b72">return</span> <span style="color: #79c0ff">True</span>

    <span style="color: #ff7b72">async</span> <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">worker</span><span style="color: #e6edf3">(self):</span>
        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: starting worker"</span><span style="color: #e6edf3">)</span>
        <span style="color: #ff7b72">try</span><span style="color: #e6edf3">:</span>
            <span style="color: #ff7b72">while</span> <span style="color: #a5d6ff">1</span><span style="color: #e6edf3">:</span>
                <span style="color: #e6edf3">client_id,</span> <span style="color: #e6edf3">binary</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">socket</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">recv_multipart()</span>
                <span style="color: #e6edf3">message</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">unpickle(binary)</span>
                <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">} got message: {</span><span style="color: #e6edf3">message</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
                <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">check_error(message):</span>
                    <span style="color: #ff7b72">continue</span>

                <span style="color: #e6edf3">cmd</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">message</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">get(</span><span style="color: #a5d6ff">"c"</span><span style="color: #e6edf3">,</span> <span style="color: #79c0ff">None</span><span style="color: #e6edf3">)</span>
                <span style="color: #ff7b72">if</span> <span style="color: #ff7b72; font-weight: bold">not</span> <span style="color: #e6edf3">isinstance(cmd,</span> <span style="color: #e6edf3">int):</span>
                    <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">warning(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: no command sent in message: {</span><span style="color: #e6edf3">message</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
                    <span style="color: #ff7b72">continue</span>

                <span style="color: #8b949e; font-style: italic"># -1 == cancel task</span>
                <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">cmd</span> <span style="color: #ff7b72; font-weight: bold">==</span> <span style="color: #ff7b72; font-weight: bold">-</span><span style="color: #a5d6ff">1</span><span style="color: #e6edf3">:</span>
                    <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">} got cancel signal"</span><span style="color: #e6edf3">)</span>
                    <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">send_socket_multipart(client_id,</span> <span style="color: #e6edf3">{</span><span style="color: #a5d6ff">"m"</span><span style="color: #e6edf3">:</span> <span style="color: #a5d6ff">"CANCEL_OK"</span><span style="color: #e6edf3">})</span>
                    <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">cancel_task(client_id)</span>
                    <span style="color: #ff7b72">continue</span>

                <span style="color: #8b949e; font-style: italic"># -99 == shutdown task</span>
                <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">cmd</span> <span style="color: #ff7b72; font-weight: bold">==</span> <span style="color: #ff7b72; font-weight: bold">-</span><span style="color: #a5d6ff">99</span><span style="color: #e6edf3">:</span>
                    <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">verbose(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">} got shutdown signal"</span><span style="color: #e6edf3">)</span>
                    <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">send_socket_multipart(client_id,</span> <span style="color: #e6edf3">{</span><span style="color: #a5d6ff">"m"</span><span style="color: #e6edf3">:</span> <span style="color: #a5d6ff">"SHUTDOWN_OK"</span><span style="color: #e6edf3">})</span>
                    <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_shutdown()</span>
                    <span style="color: #ff7b72">return</span>

                <span style="color: #e6edf3">args</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">message</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">get(</span><span style="color: #a5d6ff">"a"</span><span style="color: #e6edf3">,</span> <span style="color: #e6edf3">())</span>
                <span style="color: #ff7b72">if</span> <span style="color: #ff7b72; font-weight: bold">not</span> <span style="color: #e6edf3">isinstance(args,</span> <span style="color: #e6edf3">tuple):</span>
                    <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">warning(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: received invalid args of type {</span><span style="color: #e6edf3">type(args)</span><span style="color: #a5d6ff">}, should be tuple"</span><span style="color: #e6edf3">)</span>
                    <span style="color: #ff7b72">continue</span>
                <span style="color: #e6edf3">kwargs</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">message</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">get(</span><span style="color: #a5d6ff">"k"</span><span style="color: #e6edf3">,</span> <span style="color: #e6edf3">{})</span>
                <span style="color: #ff7b72">if</span> <span style="color: #ff7b72; font-weight: bold">not</span> <span style="color: #e6edf3">isinstance(kwargs,</span> <span style="color: #e6edf3">dict):</span>
                    <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">warning(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: received invalid kwargs of type {</span><span style="color: #e6edf3">type(kwargs)</span><span style="color: #a5d6ff">}, should be dict"</span><span style="color: #e6edf3">)</span>
                    <span style="color: #ff7b72">continue</span>

                <span style="color: #e6edf3">command_name</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">CMDS[cmd]</span>
                <span style="color: #e6edf3">command_fn</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">getattr(self,</span> <span style="color: #e6edf3">command_name,</span> <span style="color: #79c0ff">None</span><span style="color: #e6edf3">)</span>

                <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">command_fn</span> <span style="color: #ff7b72; font-weight: bold">is</span> <span style="color: #79c0ff">None</span><span style="color: #e6edf3">:</span>
                    <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">warning(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">'{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">} has no function named "{</span><span style="color: #e6edf3">command_fn</span><span style="color: #a5d6ff">}"'</span><span style="color: #e6edf3">)</span>
                    <span style="color: #ff7b72">continue</span>

                <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">inspect</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">isasyncgenfunction(command_fn):</span>
                    <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: creating run-and-yield coroutine for {</span><span style="color: #e6edf3">command_name</span><span style="color: #a5d6ff">}()"</span><span style="color: #e6edf3">)</span>
                    <span style="color: #e6edf3">coroutine</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">run_and_yield(client_id,</span> <span style="color: #e6edf3">command_fn,</span> <span style="color: #ff7b72; font-weight: bold">*</span><span style="color: #e6edf3">args,</span> <span style="color: #ff7b72; font-weight: bold">**</span><span style="color: #e6edf3">kwargs)</span>
                <span style="color: #ff7b72">else</span><span style="color: #e6edf3">:</span>
                    <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: creating run-and-return coroutine for {</span><span style="color: #e6edf3">command_name</span><span style="color: #a5d6ff">}()"</span><span style="color: #e6edf3">)</span>
                    <span style="color: #e6edf3">coroutine</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">run_and_return(client_id,</span> <span style="color: #e6edf3">command_fn,</span> <span style="color: #ff7b72; font-weight: bold">*</span><span style="color: #e6edf3">args,</span> <span style="color: #ff7b72; font-weight: bold">**</span><span style="color: #e6edf3">kwargs)</span>

                <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: creating task for {</span><span style="color: #e6edf3">command_name</span><span style="color: #a5d6ff">}() coroutine"</span><span style="color: #e6edf3">)</span>
                <span style="color: #e6edf3">task</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">create_task(coroutine)</span>
                <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">tasks[client_id]</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">task,</span> <span style="color: #e6edf3">command_fn,</span> <span style="color: #e6edf3">args,</span> <span style="color: #e6edf3">kwargs</span>
                <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: finished creating task for {</span><span style="color: #e6edf3">command_name</span><span style="color: #a5d6ff">}() coroutine"</span><span style="color: #e6edf3">)</span>
        <span style="color: #ff7b72">except</span> <span style="color: #f0883e; font-weight: bold">BaseException</span> <span style="color: #ff7b72">as</span> <span style="color: #e6edf3">e:</span>
            <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_shutdown()</span>
            <span style="color: #ff7b72">if</span> <span style="color: #ff7b72; font-weight: bold">not</span> <span style="color: #e6edf3">in_exception_chain(e,</span> <span style="color: #e6edf3">(</span><span style="color: #f0883e; font-weight: bold">KeyboardInterrupt</span><span style="color: #e6edf3">,</span> <span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">CancelledError)):</span>
                <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">error(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: error in EngineServer worker: {</span><span style="color: #e6edf3">e</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
                <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">trace(traceback</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">format_exc())</span>
        <span style="color: #ff7b72">finally</span><span style="color: #e6edf3">:</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: finished worker()"</span><span style="color: #e6edf3">)</span>

    <span style="color: #ff7b72">async</span> <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">_shutdown</span><span style="color: #e6edf3">(self):</span>
        <span style="color: #ff7b72">if</span> <span style="color: #ff7b72; font-weight: bold">not</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_shutdown_status:</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">verbose(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: shutting down..."</span><span style="color: #e6edf3">)</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_shutdown_status</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #79c0ff">True</span>
            <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">cancel_all_tasks()</span>
            <span style="color: #e6edf3">context</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">getattr(self,</span> <span style="color: #a5d6ff">"context"</span><span style="color: #e6edf3">,</span> <span style="color: #79c0ff">None</span><span style="color: #e6edf3">)</span>
            <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">context</span> <span style="color: #ff7b72; font-weight: bold">is</span> <span style="color: #ff7b72; font-weight: bold">not</span> <span style="color: #79c0ff">None</span><span style="color: #e6edf3">:</span>
                <span style="color: #ff7b72">try</span><span style="color: #e6edf3">:</span>
                    <span style="color: #e6edf3">context</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">destroy(linger</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #a5d6ff">0</span><span style="color: #e6edf3">)</span>
                <span style="color: #ff7b72">except</span> <span style="color: #f0883e; font-weight: bold">Exception</span><span style="color: #e6edf3">:</span>
                    <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">trace(traceback</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">format_exc())</span>
                <span style="color: #ff7b72">try</span><span style="color: #e6edf3">:</span>
                    <span style="color: #e6edf3">context</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">term()</span>
                <span style="color: #ff7b72">except</span> <span style="color: #f0883e; font-weight: bold">Exception</span><span style="color: #e6edf3">:</span>
                    <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">trace(traceback</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">format_exc())</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">verbose(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: finished shutting down"</span><span style="color: #e6edf3">)</span>

    <span style="color: #ff7b72">async</span> <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">task_pool</span><span style="color: #e6edf3">(self,</span> <span style="color: #e6edf3">fn,</span> <span style="color: #e6edf3">args_kwargs,</span> <span style="color: #e6edf3">threads</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #a5d6ff">10</span><span style="color: #e6edf3">,</span> <span style="color: #e6edf3">timeout</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #a5d6ff">300</span><span style="color: #e6edf3">,</span> <span style="color: #e6edf3">global_kwargs</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #79c0ff">None</span><span style="color: #e6edf3">):</span>
        <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">global_kwargs</span> <span style="color: #ff7b72; font-weight: bold">is</span> <span style="color: #79c0ff">None</span><span style="color: #e6edf3">:</span>
            <span style="color: #e6edf3">global_kwargs</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">{}</span>

        <span style="color: #e6edf3">tasks</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">{}</span>
        <span style="color: #e6edf3">args_kwargs</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">list(args_kwargs)</span>

        <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">new_task</span><span style="color: #e6edf3">():</span>
            <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">args_kwargs:</span>
                <span style="color: #e6edf3">kwargs</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">{}</span>
                <span style="color: #e6edf3">tracker</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #79c0ff">None</span>
                <span style="color: #e6edf3">args</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">args_kwargs</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">pop(</span><span style="color: #a5d6ff">0</span><span style="color: #e6edf3">)</span>
                <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">isinstance(args,</span> <span style="color: #e6edf3">(list,</span> <span style="color: #e6edf3">tuple)):</span>
                    <span style="color: #8b949e; font-style: italic"># you can specify a custom tracker value if you want</span>
                    <span style="color: #8b949e; font-style: italic"># this helps with correlating results</span>
                    <span style="color: #ff7b72">with</span> <span style="color: #e6edf3">suppress(</span><span style="color: #f0883e; font-weight: bold">ValueError</span><span style="color: #e6edf3">):</span>
                        <span style="color: #e6edf3">args,</span> <span style="color: #e6edf3">kwargs,</span> <span style="color: #e6edf3">tracker</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">args</span>
                    <span style="color: #8b949e; font-style: italic"># or you can just specify args/kwargs</span>
                    <span style="color: #ff7b72">with</span> <span style="color: #e6edf3">suppress(</span><span style="color: #f0883e; font-weight: bold">ValueError</span><span style="color: #e6edf3">):</span>
                        <span style="color: #e6edf3">args,</span> <span style="color: #e6edf3">kwargs</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">args</span>

                <span style="color: #ff7b72">if</span> <span style="color: #ff7b72; font-weight: bold">not</span> <span style="color: #e6edf3">isinstance(kwargs,</span> <span style="color: #e6edf3">dict):</span>
                    <span style="color: #ff7b72">raise</span> <span style="color: #f0883e; font-weight: bold">ValueError</span><span style="color: #e6edf3">(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"kwargs must be dict (got: {</span><span style="color: #e6edf3">kwargs</span><span style="color: #a5d6ff">})"</span><span style="color: #e6edf3">)</span>
                <span style="color: #ff7b72">if</span> <span style="color: #ff7b72; font-weight: bold">not</span> <span style="color: #e6edf3">isinstance(args,</span> <span style="color: #e6edf3">(list,</span> <span style="color: #e6edf3">tuple)):</span>
                    <span style="color: #e6edf3">args</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">[args]</span>

                <span style="color: #e6edf3">task</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">new_child_task(fn(</span><span style="color: #ff7b72; font-weight: bold">*</span><span style="color: #e6edf3">args,</span> <span style="color: #ff7b72; font-weight: bold">**</span><span style="color: #e6edf3">kwargs,</span> <span style="color: #ff7b72; font-weight: bold">**</span><span style="color: #e6edf3">global_kwargs))</span>
                <span style="color: #e6edf3">tasks[task]</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">(args,</span> <span style="color: #e6edf3">kwargs,</span> <span style="color: #e6edf3">tracker)</span>

        <span style="color: #ff7b72">for</span> <span style="color: #e6edf3">_</span> <span style="color: #ff7b72; font-weight: bold">in</span> <span style="color: #e6edf3">range(threads):</span>  <span style="color: #8b949e; font-style: italic"># Start initial batch of tasks</span>
            <span style="color: #e6edf3">new_task()</span>

        <span style="color: #ff7b72">while</span> <span style="color: #e6edf3">tasks:</span>  <span style="color: #8b949e; font-style: italic"># While there are tasks pending</span>
            <span style="color: #8b949e; font-style: italic"># Wait for the first task to complete</span>
            <span style="color: #e6edf3">finished</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">finished_tasks(tasks,</span> <span style="color: #e6edf3">timeout</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #e6edf3">timeout)</span>
            <span style="color: #ff7b72">for</span> <span style="color: #e6edf3">task</span> <span style="color: #ff7b72; font-weight: bold">in</span> <span style="color: #e6edf3">finished:</span>
                <span style="color: #e6edf3">result</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">task</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">result()</span>
                <span style="color: #e6edf3">(args,</span> <span style="color: #e6edf3">kwargs,</span> <span style="color: #e6edf3">tracker)</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">tasks</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">pop(task)</span>
                <span style="color: #ff7b72">yield</span> <span style="color: #e6edf3">(args,</span> <span style="color: #e6edf3">kwargs,</span> <span style="color: #e6edf3">tracker),</span> <span style="color: #e6edf3">result</span>
                <span style="color: #e6edf3">new_task()</span>

    <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">new_child_task</span><span style="color: #e6edf3">(self,</span> <span style="color: #e6edf3">coro):</span>
<span style="color: #6e7681">        </span><span style="color: #a5d6ff">"""</span>
<span style="color: #a5d6ff">        Create a new asyncio task, making sure to track it based on the client id.</span>

<span style="color: #a5d6ff">        This allows the task to be automatically cancelled if its parent is cancelled.</span>
<span style="color: #a5d6ff">        """</span>
        <span style="color: #e6edf3">client_id</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">client_id_var</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">get()</span>
        <span style="color: #e6edf3">task</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">create_task(coro)</span>

        <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">client_id:</span>

            <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">remove_task</span><span style="color: #e6edf3">(t):</span>
                <span style="color: #e6edf3">tasks</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">child_tasks</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">get(client_id,</span> <span style="color: #e6edf3">set())</span>
                <span style="color: #e6edf3">tasks</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">discard(t)</span>
                <span style="color: #ff7b72">if</span> <span style="color: #ff7b72; font-weight: bold">not</span> <span style="color: #e6edf3">tasks:</span>
                    <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">child_tasks</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">pop(client_id,</span> <span style="color: #79c0ff">None</span><span style="color: #e6edf3">)</span>

            <span style="color: #e6edf3">task</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">add_done_callback(remove_task)</span>

            <span style="color: #ff7b72">try</span><span style="color: #e6edf3">:</span>
                <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">child_tasks[client_id]</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">add(task)</span>
            <span style="color: #ff7b72">except</span> <span style="color: #f0883e; font-weight: bold">KeyError</span><span style="color: #e6edf3">:</span>
                <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">child_tasks[client_id]</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">{task}</span>

        <span style="color: #ff7b72">return</span> <span style="color: #e6edf3">task</span>

    <span style="color: #ff7b72">async</span> <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">finished_tasks</span><span style="color: #e6edf3">(self,</span> <span style="color: #e6edf3">tasks,</span> <span style="color: #e6edf3">timeout</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #79c0ff">None</span><span style="color: #e6edf3">):</span>
<span style="color: #6e7681">        </span><span style="color: #a5d6ff">"""</span>
<span style="color: #a5d6ff">        Given a list of asyncio tasks, return the ones that are finished with an optional timeout</span>
<span style="color: #a5d6ff">        """</span>
        <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">tasks:</span>
            <span style="color: #ff7b72">try</span><span style="color: #e6edf3">:</span>
                <span style="color: #e6edf3">done,</span> <span style="color: #e6edf3">pending</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">wait(tasks,</span> <span style="color: #e6edf3">return_when</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">FIRST_COMPLETED,</span> <span style="color: #e6edf3">timeout</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #e6edf3">timeout)</span>
                <span style="color: #ff7b72">return</span> <span style="color: #e6edf3">done</span>
            <span style="color: #ff7b72">except</span> <span style="color: #f0883e; font-weight: bold">BaseException</span> <span style="color: #ff7b72">as</span> <span style="color: #e6edf3">e:</span>
                <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">isinstance(e,</span> <span style="color: #e6edf3">(</span><span style="color: #f0883e; font-weight: bold">TimeoutError</span><span style="color: #e6edf3">,</span> <span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">exceptions</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">TimeoutError)):</span>
                    <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">warning(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: Timeout after {</span><span style="color: #e6edf3">timeout</span><span style="color: #a5d6ff">:,} seconds in finished_tasks({</span><span style="color: #e6edf3">tasks</span><span style="color: #a5d6ff">})"</span><span style="color: #e6edf3">)</span>
                    <span style="color: #ff7b72">for</span> <span style="color: #e6edf3">task</span> <span style="color: #ff7b72; font-weight: bold">in</span> <span style="color: #e6edf3">tasks:</span>
                        <span style="color: #e6edf3">task</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">cancel()</span>
                        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_await_cancelled_task(task)</span>
                <span style="color: #ff7b72">else</span><span style="color: #e6edf3">:</span>
                    <span style="color: #ff7b72">if</span> <span style="color: #ff7b72; font-weight: bold">not</span> <span style="color: #e6edf3">in_exception_chain(e,</span> <span style="color: #e6edf3">(</span><span style="color: #f0883e; font-weight: bold">KeyboardInterrupt</span><span style="color: #e6edf3">,</span> <span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">CancelledError)):</span>
                        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">error(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: Unhandled exception in finished_tasks({</span><span style="color: #e6edf3">tasks</span><span style="color: #a5d6ff">}): {</span><span style="color: #e6edf3">e</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
                        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">trace(traceback</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">format_exc())</span>
                    <span style="color: #ff7b72">raise</span>
        <span style="color: #ff7b72">return</span> <span style="color: #e6edf3">set()</span>

    <span style="color: #ff7b72">async</span> <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">cancel_task</span><span style="color: #e6edf3">(self,</span> <span style="color: #e6edf3">client_id):</span>
        <span style="color: #e6edf3">parent_task</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">tasks</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">pop(client_id,</span> <span style="color: #79c0ff">None</span><span style="color: #e6edf3">)</span>
        <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">parent_task</span> <span style="color: #ff7b72; font-weight: bold">is</span> <span style="color: #79c0ff">None</span><span style="color: #e6edf3">:</span>
            <span style="color: #ff7b72">return</span>
        <span style="color: #e6edf3">parent_task,</span> <span style="color: #e6edf3">_cmd,</span> <span style="color: #e6edf3">_args,</span> <span style="color: #e6edf3">_kwargs</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">parent_task</span>
        <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: Cancelling client id {</span><span style="color: #e6edf3">client_id</span><span style="color: #a5d6ff">} (task: {</span><span style="color: #e6edf3">parent_task</span><span style="color: #a5d6ff">})"</span><span style="color: #e6edf3">)</span>
        <span style="color: #e6edf3">parent_task</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">cancel()</span>
        <span style="color: #e6edf3">child_tasks</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">child_tasks</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">pop(client_id,</span> <span style="color: #e6edf3">set())</span>
        <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">child_tasks:</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">engine_debug(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: Cancelling {</span><span style="color: #e6edf3">len(child_tasks)</span><span style="color: #a5d6ff">:,} child tasks for client id {</span><span style="color: #e6edf3">client_id</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
            <span style="color: #ff7b72">for</span> <span style="color: #e6edf3">child_task</span> <span style="color: #ff7b72; font-weight: bold">in</span> <span style="color: #e6edf3">child_tasks:</span>
                <span style="color: #e6edf3">child_task</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">cancel()</span>

        <span style="color: #ff7b72">for</span> <span style="color: #e6edf3">task</span> <span style="color: #ff7b72; font-weight: bold">in</span> <span style="color: #e6edf3">[parent_task]</span> <span style="color: #ff7b72; font-weight: bold">+</span> <span style="color: #e6edf3">list(child_tasks):</span>
            <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_await_cancelled_task(task)</span>

    <span style="color: #ff7b72">async</span> <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">_await_cancelled_task</span><span style="color: #e6edf3">(self,</span> <span style="color: #e6edf3">task):</span>
        <span style="color: #ff7b72">try</span><span style="color: #e6edf3">:</span>
            <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">wait_for(task,</span> <span style="color: #e6edf3">timeout</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #a5d6ff">10</span><span style="color: #e6edf3">)</span>
        <span style="color: #ff7b72">except</span> <span style="color: #e6edf3">(</span><span style="color: #f0883e; font-weight: bold">TimeoutError</span><span style="color: #e6edf3">,</span> <span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">exceptions</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">TimeoutError):</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">trace(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: Timeout cancelling task: {</span><span style="color: #e6edf3">task</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
            <span style="color: #ff7b72">return</span>
        <span style="color: #ff7b72">except</span> <span style="color: #e6edf3">(</span><span style="color: #f0883e; font-weight: bold">KeyboardInterrupt</span><span style="color: #e6edf3">,</span> <span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">CancelledError):</span>
            <span style="color: #ff7b72">return</span>
        <span style="color: #ff7b72">except</span> <span style="color: #f0883e; font-weight: bold">BaseException</span> <span style="color: #ff7b72">as</span> <span style="color: #e6edf3">e:</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">error(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"Unhandled error in {</span><span style="color: #e6edf3">task</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">get_coro()</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #79c0ff">__name__</span><span style="color: #a5d6ff">}(): {</span><span style="color: #e6edf3">e</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">trace(traceback</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">format_exc())</span>

    <span style="color: #ff7b72">async</span> <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">cancel_all_tasks</span><span style="color: #e6edf3">(self):</span>
        <span style="color: #ff7b72">for</span> <span style="color: #e6edf3">client_id</span> <span style="color: #ff7b72; font-weight: bold">in</span> <span style="color: #e6edf3">list(self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">tasks):</span>
            <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">cancel_task(client_id)</span>
        <span style="color: #ff7b72">for</span> <span style="color: #e6edf3">client_id,</span> <span style="color: #e6edf3">tasks</span> <span style="color: #ff7b72; font-weight: bold">in</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">child_tasks</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">items():</span>
            <span style="color: #ff7b72">for</span> <span style="color: #e6edf3">task</span> <span style="color: #ff7b72; font-weight: bold">in</span> <span style="color: #e6edf3">tasks:</span>
                <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_await_cancelled_task(task)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="bbot.core.engine.EngineServer.finished_tasks">
<span class="doc doc-object-name doc-function-name">finished_tasks</span>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-async"><code>async</code></small>
</span>
</h2>
<div class="doc-signature highlight" style="background: #0d1117"><pre style="line-height: 125%;"><span></span><code><span style="color: #e6edf3">finished_tasks(tasks,</span> <span style="color: #e6edf3">timeout</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #79c0ff">None</span><span style="color: #e6edf3">)</span>
</code></pre></div>
<div class="doc doc-contents">
<p>Given a list of asyncio tasks, return the ones that are finished with an optional timeout</p>
<details class="quote">
<summary>Source code in <code>bbot/core/engine.py</code></summary>
<div class="highlight" style="background: #0d1117"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">633</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">634</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">635</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">636</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">637</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">638</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">639</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">640</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">641</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">642</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">643</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">644</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">645</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">646</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">647</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">648</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">649</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">650</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">651</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">652</span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><span style="color: #ff7b72">async</span> <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">finished_tasks</span><span style="color: #e6edf3">(self,</span> <span style="color: #e6edf3">tasks,</span> <span style="color: #e6edf3">timeout</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #79c0ff">None</span><span style="color: #e6edf3">):</span>
<span style="color: #6e7681">    </span><span style="color: #a5d6ff">"""</span>
<span style="color: #a5d6ff">    Given a list of asyncio tasks, return the ones that are finished with an optional timeout</span>
<span style="color: #a5d6ff">    """</span>
    <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">tasks:</span>
        <span style="color: #ff7b72">try</span><span style="color: #e6edf3">:</span>
            <span style="color: #e6edf3">done,</span> <span style="color: #e6edf3">pending</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #ff7b72">await</span> <span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">wait(tasks,</span> <span style="color: #e6edf3">return_when</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">FIRST_COMPLETED,</span> <span style="color: #e6edf3">timeout</span><span style="color: #ff7b72; font-weight: bold">=</span><span style="color: #e6edf3">timeout)</span>
            <span style="color: #ff7b72">return</span> <span style="color: #e6edf3">done</span>
        <span style="color: #ff7b72">except</span> <span style="color: #f0883e; font-weight: bold">BaseException</span> <span style="color: #ff7b72">as</span> <span style="color: #e6edf3">e:</span>
            <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">isinstance(e,</span> <span style="color: #e6edf3">(</span><span style="color: #f0883e; font-weight: bold">TimeoutError</span><span style="color: #e6edf3">,</span> <span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">exceptions</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">TimeoutError)):</span>
                <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">warning(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: Timeout after {</span><span style="color: #e6edf3">timeout</span><span style="color: #a5d6ff">:,} seconds in finished_tasks({</span><span style="color: #e6edf3">tasks</span><span style="color: #a5d6ff">})"</span><span style="color: #e6edf3">)</span>
                <span style="color: #ff7b72">for</span> <span style="color: #e6edf3">task</span> <span style="color: #ff7b72; font-weight: bold">in</span> <span style="color: #e6edf3">tasks:</span>
                    <span style="color: #e6edf3">task</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">cancel()</span>
                    <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">_await_cancelled_task(task)</span>
            <span style="color: #ff7b72">else</span><span style="color: #e6edf3">:</span>
                <span style="color: #ff7b72">if</span> <span style="color: #ff7b72; font-weight: bold">not</span> <span style="color: #e6edf3">in_exception_chain(e,</span> <span style="color: #e6edf3">(</span><span style="color: #f0883e; font-weight: bold">KeyboardInterrupt</span><span style="color: #e6edf3">,</span> <span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">CancelledError)):</span>
                    <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">error(</span><span style="color: #79c0ff">f</span><span style="color: #a5d6ff">"{</span><span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">name</span><span style="color: #a5d6ff">}: Unhandled exception in finished_tasks({</span><span style="color: #e6edf3">tasks</span><span style="color: #a5d6ff">}): {</span><span style="color: #e6edf3">e</span><span style="color: #a5d6ff">}"</span><span style="color: #e6edf3">)</span>
                    <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">log</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">trace(traceback</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">format_exc())</span>
                <span style="color: #ff7b72">raise</span>
    <span style="color: #ff7b72">return</span> <span style="color: #e6edf3">set()</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="bbot.core.engine.EngineServer.new_child_task">
<span class="doc doc-object-name doc-function-name">new_child_task</span>
</h2>
<div class="doc-signature highlight" style="background: #0d1117"><pre style="line-height: 125%;"><span></span><code><span style="color: #e6edf3">new_child_task(coro)</span>
</code></pre></div>
<div class="doc doc-contents">
<p>Create a new asyncio task, making sure to track it based on the client id.</p>
<p>This allows the task to be automatically cancelled if its parent is cancelled.</p>
<details class="quote">
<summary>Source code in <code>bbot/core/engine.py</code></summary>
<div class="highlight" style="background: #0d1117"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">607</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">608</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">609</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">610</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">611</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">612</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">613</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">614</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">615</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">616</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">617</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">618</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">619</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">620</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">621</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">622</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">623</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">624</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">625</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">626</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">627</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">628</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">629</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">630</span>
<span style="color: #6e7681; background-color: #0d1117; padding-left: 5px; padding-right: 5px;">631</span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">new_child_task</span><span style="color: #e6edf3">(self,</span> <span style="color: #e6edf3">coro):</span>
<span style="color: #6e7681">    </span><span style="color: #a5d6ff">"""</span>
<span style="color: #a5d6ff">    Create a new asyncio task, making sure to track it based on the client id.</span>

<span style="color: #a5d6ff">    This allows the task to be automatically cancelled if its parent is cancelled.</span>
<span style="color: #a5d6ff">    """</span>
    <span style="color: #e6edf3">client_id</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">client_id_var</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">get()</span>
    <span style="color: #e6edf3">task</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">asyncio</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">create_task(coro)</span>

    <span style="color: #ff7b72">if</span> <span style="color: #e6edf3">client_id:</span>

        <span style="color: #ff7b72">def</span> <span style="color: #d2a8ff; font-weight: bold">remove_task</span><span style="color: #e6edf3">(t):</span>
            <span style="color: #e6edf3">tasks</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">child_tasks</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">get(client_id,</span> <span style="color: #e6edf3">set())</span>
            <span style="color: #e6edf3">tasks</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">discard(t)</span>
            <span style="color: #ff7b72">if</span> <span style="color: #ff7b72; font-weight: bold">not</span> <span style="color: #e6edf3">tasks:</span>
                <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">child_tasks</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">pop(client_id,</span> <span style="color: #79c0ff">None</span><span style="color: #e6edf3">)</span>

        <span style="color: #e6edf3">task</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">add_done_callback(remove_task)</span>

        <span style="color: #ff7b72">try</span><span style="color: #e6edf3">:</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">child_tasks[client_id]</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">add(task)</span>
        <span style="color: #ff7b72">except</span> <span style="color: #f0883e; font-weight: bold">KeyError</span><span style="color: #e6edf3">:</span>
            <span style="color: #e6edf3">self</span><span style="color: #ff7b72; font-weight: bold">.</span><span style="color: #e6edf3">child_tasks[client_id]</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #e6edf3">{task}</span>

    <span style="color: #ff7b72">return</span> <span style="color: #e6edf3">task</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "content.tooltips", "navigation.tabs", "navigation.sections", "navigation.expand", "toc.integrate"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": "Stable", "provider": "mike"}}</script>
<script src="../../assets/javascripts/bundle.83f73b43.min.js"></script>
<script src="../../javascripts/tablesort.js"></script>
<script src="../../javascripts/tablesort.min.js"></script>
<script src="../../javascripts/vega@5.js"></script>
<script src="../../javascripts/vega-lite@5.js"></script>
<script src="../../javascripts/vega-embed@6.js"></script>
</body>
</html>